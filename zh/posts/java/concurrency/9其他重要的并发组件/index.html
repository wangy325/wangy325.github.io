<!doctype html><html lang=zh dir=ltr>
<head prefix="og: http://ogp.me/ns#">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Java并发系列之9——倒计时门闩、信号量、交换器及其他 – EndlessRiver</title>
<script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script>
<script defer src=/js/helper/getParents.min.ccd45f158c1b17849307ba913a72beac239c410f2b6e648496a79842da84e55b.js></script>
<script defer src=/js/helper/fadeinout.min.1d13d3e810c3940e80cbba6216a1c76fbf42b5431fc83537ea6997863802362b.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(b,a){'use strict';if(b instanceof RegExp)throw TypeError('first argument must not be a RegExp');return a===void 0&&(a=0),this.indexOf(b,a)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(a){if(!a.length)throw new Error('DOM Exception 8');if(a.length===1)return typeof a[0]=='string'?document.createTextNode(a[0]):a[0];for(var c=document.createDocumentFragment(),e=a.length,d=-1,b;++d<e;)b=a[d],c.appendChild(typeof b=='string'?document.createTextNode(b):b);return c}String.prototype.startsWith||(String.prototype.startsWith=function(b,a){return a=a||0,this.indexOf(b,a)===a}),document.addEventListener('DOMContentLoaded',function(){var A=document.querySelector('.navbar__burger'),V,F,G,Q,P,f,e,O,t,ag,K,I,o,g,z,l,b,r,s,W,H,d,E,h,B,C,ap,y,ao,an,am,al,ak,D,ac,aj,ah,ae,j,i,c,ad,w,Z,U,ab,x,p,R,m,ar,aq,a,at,L,n,J,S,T,u,q,v;A?A.addEventListener('click',function(c){var a=document.querySelector('.navbarm__collapse'),b;a&&(b=a.getAttribute('data-open'),b==='true'?(a.setAttribute('data-open','false'),a.style.maxHeight=0,A.classList.remove('is-active')):(a.setAttribute('data-open','true'),a.style.maxHeight=a.scrollHeight+"px",A.classList.add('is-active')))}):null,V=document.querySelectorAll('.single__contents > table');for(let a=0;a<V.length;a++)F=V[a],G=document.createElement('div'),G.className='table-wrapper',F.parentElement.replaceChild(G,F),G.appendChild(F);Q=document.querySelectorAll('.footnote-ref'),P=document.querySelectorAll('.footnote-backref'),Q?Q.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,P?P.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,f=document.querySelector('.summary__container'),e=document.querySelector('.search-result'),O=document.querySelector('.search-result__close'),O?O.addEventListener('click',function(a){e.setAttribute('data-display','none'),f.setAttribute('data-display','block')}):null,document.querySelectorAll('.tab')?document.querySelectorAll('.tab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.tab__link'),c=a.querySelectorAll('.tab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,document.querySelectorAll('.codetab')?document.querySelectorAll('.codetab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.codetab__link'),c=a.querySelectorAll('.codetab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,t=document.getElementById("gtt"),t.style.display="none",t.addEventListener('click',function(){window.document.documentMode?document.documentElement.scrollTop=0:af(250)});function af(a){var b=-window.scrollY/(a/15),c=setInterval(function(){window.scrollY!=0?window.scrollBy(0,b):clearInterval(c)},15)}ag=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?t.style.display="block":t.style.display="none"},K=document.querySelectorAll('.expand__button');for(let a=0;a<K.length;a++)K[a].addEventListener("click",function(){var a=this.nextElementSibling;a.style.maxHeight?(a.style.maxHeight=null,this.querySelector('svg').classList.add('expand-icon__right'),this.querySelector('svg').classList.remove('expand-icon__down')):(a.style.maxHeight=a.scrollHeight+"px",this.querySelector('svg').classList.remove('expand-icon__right'),this.querySelector('svg').classList.add('expand-icon__down'))});I=window.pageYOffset||document.documentElement.scrollTop,o=document.querySelector('.toc'),g=o?o.querySelector('#TableOfContents'):null,z=document.getElementById('toggle-toc'),l=document.querySelector('.single__contents'),b=document.querySelector('.navbar'),r=document.querySelector('.toc__flexbox'),s=document.querySelector('.toc__flexbox--outer'),W=document.querySelectorAll('.expand__content'),H=document.querySelectorAll('.box'),d=null,E=JSON.parse("false"),h=JSON.parse('["h2","h3","h4"]'),h?h=h.toString():h="h1, h2, h3, h4, h5, h6",l&&l.querySelectorAll(".tab")?l.querySelectorAll(".tab").forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,W?W.forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,H?H.forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,window.onscroll=function(){ag();var a=window.pageYOffset||document.documentElement.scrollTop;if(a>I){if(a<250?t.style.display="none":t.style.display="block",a<45)return null;b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.contains('navbar--show')&&b.classList.remove('navbar--show'):b.classList.add('navbar--hide')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(z&&!z.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===E||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&(r.setAttribute('data-position',''),r.classList.contains('hide')||r.classList.add('hide')),s&&(s.setAttribute('data-position',''),s.classList.contains('hide')||s.classList.add('hide'))))}else a<250&&(t.style.display="none"),b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.remove('navbar--hide'):b.classList.contains('navbar--show')||b.classList.add('navbar--show')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(z&&!z.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===E||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&!r.classList.contains('hide')&&r.classList.add('hide'),s&&!s.classList.contains('hide')&&s.classList.add('hide'))),g&&document.documentElement.scrollTop<250&&(!1===E||(g.querySelector('ul')?g.querySelector('ul').querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})}):null));I=a<=0?0:a},B=localStorage.getItem('theme'),C=document.getElementById('root'),ap=document.querySelectorAll('.select-theme'),y=document.querySelectorAll('.select-theme__item'),ao=JSON.parse('"dark"'),an=JSON.parse('"light"'),am=JSON.parse('"hacker"'),al=JSON.parse('"solarized"'),ak=JSON.parse('"kimbie"'),D=function(a){var b=document.getElementsByName('msapplication-TileColor')[0],c=document.getElementsByName('theme-color')[0],d=document.getElementsByName('msapplication-navbutton-color')[0],e=document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];a.includes('dark')?(b.setAttribute('content','#fcfcfa'),c.setAttribute('content','#403E41'),d.setAttribute('content','#403E41'),e.setAttribute('content','#403E41')):a.includes('light')?(b.setAttribute('content','#555'),c.setAttribute('content','#eee'),d.setAttribute('content','#eee'),e.setAttribute('content','#eee')):a.includes('hacker')?(b.setAttribute('content','#e3cd26'),c.setAttribute('content','#252526'),d.setAttribute('content','#252526'),e.setAttribute('content','#252526')):a.includes('solarized')?(b.setAttribute('content','#d3af86'),c.setAttribute('content','#51412c'),d.setAttribute('content','#51412c'),e.setAttribute('content','#51412c')):a.includes('kimbie')&&(b.setAttribute('content','#586e75'),c.setAttribute('content','#eee8d5'),d.setAttribute('content','#eee8d5'),e.setAttribute('content','#eee8d5'))},ac=function(a){if(a===ao)return'dark';if(a===an)return'light';if(a===am)return'hacker';if(a===al)return'solarized';if(a===ak)return'kimbie'},B?(y?y.forEach(function(a){a.text.trim()===B?a.classList.add('is-active'):a.classList.remove('is-active')}):null,D(B)):D(C.className),y?y.forEach(function(a,b){a.addEventListener('click',function(c){var a=ac(c.target.text.trim()),b,d;localStorage.setItem('theme',a),D(a),C.removeAttribute('class'),C.classList.add('theme__'+a),ap.forEach(function(b){b.querySelectorAll('a').forEach(function(b){b.classList&&(b.text.trim()===a?b.classList.contains('is-active')||b.classList.add('is-active'):b.classList.contains('is-active')&&b.classList.remove('is-active'))})}),window.mermaid&&(a==="dark"||a==="hacker"?(mermaid.initialize({theme:'dark'}),location.reload()):(mermaid.initialize({theme:'default'}),location.reload())),b=document.getElementById('utterances'),b&&b.querySelector('iframe').contentWindow.postMessage({type:'set-theme',theme:a==="dark"||a==="hacker"?'photon-dark':a==='kimbie'?'github-dark-orange':'github-light'},'https://utteranc.es'),d=document.querySelectorAll('.twitter-timeline'),d&&window.postMessage({type:'set-twitter-theme',theme:a==='light'||a==='solarized'?'light':'dark'})})}):null,aj=JSON.parse('"https://wangy325.github.io"'),ah=JSON.parse('"https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/"'),ae=JSON.parse('"/zh"'),j=null,i=null,c=null,ad=JSON.parse("true"),w=JSON.parse("true"),Z=JSON.parse('"main"'),U=JSON.parse('"posts"'),ab=JSON.parse('"page"'),x=null,ad&&function(){var a=new XMLHttpRequest;U==="publication"&&ab!=="page"?a.open('GET',ah+"index.json"):a.open('GET',aj+ae+"/index.json"),a.setRequestHeader('Content-Type','application/json; charset=utf-8'),a.onload=function(){a.status===200?(x=new Fuse(JSON.parse(a.response.toString('utf-8')),{keys:U.includes('publication')?['title','abstract']:['title','description','content'],includeMatches:w,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=x):console.error('['+a.status+']Error:',a.statusText)},a.send()}();function ai(e,a){var b=document.createElement('li'),c,d;b.className='search-result__item',c=document.createElement('a'),c.innerHTML=a.item.title,c.setAttribute('class','search-result__item--title'),c.setAttribute('href',a.item.permalink),d=document.createElement('div'),d.setAttribute('class','search-result__item--desc'),a.item.description?d.innerHTML=a.item.description:a.item.content&&(d.innerHTML=a.item.content.substring(0,225)),b.appendChild(c),b.appendChild(d),e.appendChild(b)}function $(f,a){var e=document.createElement('li'),b,d,c;if(e.className='search-result__item',b=null,d=document.createElement('a'),d.innerHTML=a.item.title,d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri),a.matches&&a.matches.length){for(c=0;c<a.matches.length;c++)'title'===a.matches[c].key&&(d=document.createElement('a'),d.innerHTML=k(a.matches[c].value,a.matches[c].indices),d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri)),'description'===a.matches[c].key?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.description,a.matches[c].indices)):'content'===a.matches[c].key?b||(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.content.substring(0,150),a.matches[c].indices)):a.item.description?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.description):(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.content.substring(0,150));e.appendChild(d),b&&e.appendChild(b),e&&f.appendChild(e)}}function Y(d,c){var a,b;for(j=document.getElementById('search-results'),i=document.getElementById('search-menu'),j.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var e=document.createElement('li'),c=document.createElement('a'),f,d;c.setAttribute('href',b.uri),c.setAttribute('class','dropdown-item'),c.appendChild(e),f=document.createElement('div'),f.innerHTML=b.title,f.setAttribute('class','menu-item__title'),d=document.createElement('div'),d.setAttribute('class','menu-item__desc'),b.description?d.innerHTML=b.description:b.content&&(d.innerHTML=b.content.substring(0,150)),e.appendChild(f),e.appendChild(d),a.appendChild(c)}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function M(d,c){var a,b;for(j=document.getElementById('search-results'),i=document.getElementById('search-menu'),j.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var g=document.createElement('li'),e=document.createElement('a'),c=null,f,d;if(e.setAttribute('href',b.item.uri),e.setAttribute('class','dropdown-item'),e.appendChild(g),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','menu-item__title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.content.substring(0,150));g.appendChild(f),c&&g.appendChild(c),a.appendChild(e)}}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function X(e,c){var a,d;j=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length>0?c.forEach(function(b){var c=document.createElement('a');c.setAttribute('href',b.uri),c.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+b.title+'</div><div class="mobile-search__item--desc">'+(b.description?b.description:b.content)+'</div></div>',a.appendChild(c)}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);j.appendChild(a)}function aa(e,c){var a,d;j=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length?c.forEach(function(b){var e=document.createElement('li'),g=document.createElement('a'),c=null,f,d;if(g.setAttribute('href',b.item.uri),g.appendChild(e),e.setAttribute('class','mobile-search__item'),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','mobile-search__item--title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.content.substring(0,150));e.appendChild(f),c&&e.appendChild(c),a.appendChild(g)}}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);j.appendChild(a)}function k(a,d){if(!d)return a;var b='',c=0;return d.forEach(function(d){if(d[0]===d[1])return null;b+=''+a.substring(c,d[0])+'<span class="search__highlight">'+a.substring(d[0],d[1]+1)+'</span>'+'',c=d[1]+1}),b+=a.substring(c),b}p=document.getElementById('search'),R=document.getElementById('search-mobile'),m=document.getElementById('search-results'),p?p.addEventListener('input',function(b){var a,d;if(!b.target.value|window.innerWidth<770)return m?m.setAttribute('class','dropdown'):null,e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null,null;c=b.target.value,a=x.search(b.target.value),Z==="main"?w?_(c,a):N(c,a):(w?M(c,a):Y(c,a),d=m.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,p?p.addEventListener('blur',function(){if(window.innerWidth<770)return null;m?m.setAttribute('class','dropdown'):null}):null,p?p.addEventListener('click',function(b){var a,d;if(window.innerWidth<770)return null;if(!b.target.value)return m?m.setAttribute('class','dropdown'):null,null;c=b.target.value,a=x.search(b.target.value),Z==="main"?w?_(c,a):N(c,a):(w?M(c,a):Y(c,a),d=m.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,ar=document.getElementById("search-menu"),aq=document.querySelector('#search-menu .dropdown-item.is-active'),a=null,at=null,L=350,p?p.addEventListener('keydown',function(c){var b,d;if(window.innerWidth<770)return null;if(c.key==='Escape'&&(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b=document.querySelectorAll('#search-menu .dropdown-item'),d=c.which||c.keyCode,!b||!b.length)return null;if(c.key==='ArrowDown'||d===40){a===null?(a=0,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===b.length-1?0:a+1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-L;c>0?document.querySelector(".search-content").scrollTop+=b[a].getBoundingClientRect().height:a===0&&(document.querySelector(".search-content").scrollTop=0)}else if(c.key==='ArrowUp'||d===38){a===null?(a=b.length-1,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===0?b.length-1:a-1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-L;c<0?document.querySelector(".search-content").scrollTop-=b[a].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=c+b[a].getBoundingClientRect().height}else c.key==='Enter'||d===13?b[a]&&b[a].getAttribute('href')&&(location.href=b[a].getAttribute('href')):(c.key==='Escape'||d===27)&&(c.target.value=null,j&&j.classList.remove('is-active'))}):null,R?R.addEventListener('input',function(a){if(!a.target.value){let a=document.getElementById('search-mobile-results');while(a.firstChild)a.removeChild(a.firstChild);return null}c=a.target.value;var b=x.search(a.target.value);X(c,b),w?aa(c,b):X(c,b)}):null,n=document.querySelector('#search-mobile'),J=document.querySelector('.mobile-search'),S=document.querySelectorAll('.navbar-search'),T=document.querySelector('#search-mobile-close'),u=document.querySelector('#search-mobile-container'),q=document.querySelector('#search-mobile-results'),v=document.querySelector('html'),J&&(J.style.display='none'),S?S.forEach(function(a,b){a.addEventListener('click',function(){u&&(u.style.display='block'),n&&n.focus(),v&&(v.style.overflowY='hidden')})}):null,T?T.addEventListener('click',function(){if(u&&(u.style.display='none'),n&&(n.value=''),q)while(q.firstChild)q.removeChild(q.firstChild);v&&(v.style.overflowY='visible')}):null,n?n.addEventListener('keydown',function(a){var b=a.which||a.keyCode;if(a.key==='Escape'||b===27){if(u&&(u.style.display='none'),n&&(n.value=''),q)while(q.firstChild)q.removeChild(q.firstChild);v&&(v.style.overflowY='visible')}}):null;function N(d,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');d?a&&a&&a.length&&(a.forEach(function(a){ai(c,a)}),e?e.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}function _(d,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');d?a&&a&&a.length&&(a.forEach(function(a){$(c,a)}),e?e.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}})</script>
<link rel=stylesheet href=/css/main.min.css>
<meta name=description content="本文介绍了juc包中其他常用的并发组件，包括倒计时门闩，信号量，交换器等。">
<meta name=keywords content="信号量,交换器">
<meta name=created content="2020-11-16T00:00:00+0000">
<meta name=modified content="2022-10-16T17:16:58+0000">
<meta property="article:published_time" content="2020-11-16T00:00:00+0000">
<meta name=author content="wangy325">
<meta property="article:author" content="https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/@wangy325">
<meta property="og:site_name" content="EndlessRiver">
<meta property="og:title" content="Java并发系列之9——倒计时门闩、信号量、交换器及其他">
<meta property="og:url" content="https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/">
<meta property="og:type" content="article">
<meta property="og:description" content="本文介绍了juc包中其他常用的并发组件，包括倒计时门闩，信号量，交换器等。">
<meta name=generator content="Hugo 0.87.0">
<meta name=msapplication-TileColor content="#fff">
<meta name=theme-color content="#fff">
<meta name=msapplication-navbutton-color content="#fff">
<meta name=apple-mobile-web-app-status-bar-style content="#fff">
<link rel=canonical href=https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/>
<link rel=manifest href=/manifest.json>
<link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png>
<link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png>
<link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png>
<link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png>
<link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png>
<meta name=msapplication-TileColor content="#ffffff">
<meta name=msapplication-TileImage content="/ms-icon-144x144.png">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","headline":"Java并发系列之9——倒计时门闩、信号量、交换器及其他","datePublished":"2020-11-16T00:00:00Z","dateModified":"2022-10-16T17:16:58Z","url":"https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/","description":"本文介绍了juc包中其他常用的并发组件，包括倒计时门闩，信号量，交换器等。","keywords":["信号量","交换器"],"author":{"@type":"Person","name":"wangy325"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangy325.github.io"},"publisher":{"@type":"Organization","name":"EndlessRiver","url":"https://wangy325.github.io"}}</script>
<script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</head>
<body id=root class=theme__light>
<script>var localTheme=localStorage.getItem('theme');localTheme&&(document.getElementById('root').className='theme__'+localTheme)</script>
<div id=container>
<div class=wrapper data-type=posts data-kind=page>
<nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr>
<div class=navbar__brand>
<a href=/zh/ title=主页 rel=home class=navbar__logo-link>
<img src=/logo.png alt=Home class=navbar__logo>
</a>
<a href=/zh/ title=主页 rel=home class=navbar__title-link>
<h6 class=navbar__title></h6>
</a>
</div>
<div class="theme theme-mobile" data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
light
</a>
<a href=# class="dropdown-item select-theme__item">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
<a href=# class="dropdown-item select-theme__item">
kimbie
</a>
</div>
</div>
</div>
<div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</div>
<div id=search-mobile-container class="mobile-search hide" data-dir=ltr>
<div class=mobile-search__top>
<input id=search-mobile type=text aria-label="Mobile Search" placeholder=搜索 class=mobile-search__top--input>
<div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg>
</div>
</div>
<div id=search-mobile-results class=mobile-search__body>
</div>
</div>
<a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<div class=navbarm__collapse data-open=false>
<ul dir=ltr>
<li class="navbarm__menu--item active">
<a href=/zh/posts>文章</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/archive>归档</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/showcase>代码</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/about>关于</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/friend>友链</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/tags class=navbarm__menu--term data-index=0>
标签
</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/categories class=navbarm__menu--term data-index=1>
分类
</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/series class=navbarm__menu--term data-index=2>
系列
</a>
</li>
</ul>
</div>
<div class=navbar__menu>
<div class=theme data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
light
</a>
<a href=# class="dropdown-item select-theme__item">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
<a href=# class="dropdown-item select-theme__item">
kimbie
</a>
</div>
</div>
</div>
<a href=/zh/posts class="navbar__menu-item navbar__slide-down active" dir=ltr data-ani=true>文章</a>
<a href=/zh/archive class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>归档</a>
<a href=/zh/showcase class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>代码</a>
<a href=/zh/about class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>关于</a>
<a href=/zh/friend class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>友链</a>
</div>
</nav>
<main class="single__main main">
<nav class="breadcrumb hide" aria-label=breadcrumbs>
<script>document.querySelector('.breadcrumb').classList.remove('hide')</script>
<ol>
<li>
<a href=https://wangy325.github.io/zh/ class=capitalize>EndlessRiver</a>
</li>
<li>
<a href=https://wangy325.github.io/zh/posts/ class=capitalize>文章列表</a>
</li>
<li class=is-active>
<span>Java并发系列之9——倒计时门闩、信号量、交换器及其他</span>
</li>
</ol>
</nav>
<div class=single>
<div class=single__nojs>Please enable Javascript to view the contents</div>
<script>document.querySelector('.single').classList.remove('hide'),document.querySelector('.single__nojs').classList.add('hide')</script>
<h2 class=single__title data-ani=true>Java并发系列之9——倒计时门闩、信号量、交换器及其他</h2>
<h3 class=single__subtitle></h3>
<div class=single__meta>
<div class=single__infos>
<time class=single__info title=创建日期>📅&nbsp;2020年11月16日 </time>
&nbsp;&#183;&nbsp; <time class=single__info title=更新日期> 📝&nbsp;2022年10月16日 </time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长> ☕&nbsp;22&nbsp;分钟 </span>
&nbsp;&#183;&nbsp; <span class=single__info title=作者>✍️&nbsp;wangy325</span>
<span class=single__info>
&#183; 👀<span id=busuanzi_value_page_pv>...</span> 阅读
</span>
</div>
<ul class="single__tags caption">
🏷️
<li><a href=https://wangy325.github.io/zh/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/ class=single__tag title=信号量>#信号量</a></li>
<li><a href=https://wangy325.github.io/zh/tags/%E4%BA%A4%E6%8D%A2%E5%99%A8/ class=single__tag title=交换器>#交换器</a></li>
</ul>
</div>
<article class=single__contents data-dir=ltr data-ani=true>
<p>Java 1.5以后的并发类库新加入了一些用于解决并发问题的新构件，合理地使用这些构件能够帮助我们写出更加简单且健壮的并发程序。本节内容介绍<code>java.util.concurrent</code>包中一些具有代表性的构件，包括</p>
<ul>
<li>CountDownLatch</li>
<li>CyclicBarrier</li>
<li>Semaphore</li>
<li>Exchanger</li>
<li>DelayQueue</li>
<li>PriorityBlockingQueue</li>
</ul>
<h1 id=1-countdownlatch>1 CountDownLatch</h1>
<p>在讨论线程的基本概念时，我们说过<code>join()</code>方法可使当前线程等待调用join方法的线程执行完，可以实现简单的<a href=../%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5-%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80%E4%B9%8B%E4%B8%80/#9-%E5%8A%A0%E5%85%A5%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8Bjoin>无锁同步</a>，使用CountDownLatch可以更加简单的实现这一目的。毕竟，<code>join()</code>方法的语义“加入一个线程”不是很容易就能让人理解。相较于<code>join()</code>方法，CountDownLatch的语义就明确多了。</p>
<p>在有些文档上，将CountDownLatch译为"倒计时门闩【shuān】"，其维护一个计数器，这个计数器在CountDownLatch初始化之后便<strong>不能重置</strong>。在CountDownLatch上调用<code>countDown()</code>方法来将计数值减1，调用这个方法并不会引起阻塞。不过，在这个计数器为0之前，任何调用CountDownLatch的<code>await()</code>方法的任务都将阻塞。</p>
<p>CountDownLatch的典型用法是将一个任务分割为n个可以独立解决的部分，并创建一个计数器值为n的CountDownLatch，在每个任务完成时，调用<code>countDown()</code>方法将计数器减1，在等待所有任务完成的线程上调用<code>await()</code>方法，将任务阻塞，知道计数器为0之后再继续运行。</p>
<p>下面的代码演示了CountdownLatch的用法</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CountDownLatchDemo</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>TaskPortion</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=n>47</span><span class=o>);</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>;</span>

        <span class=n>TaskPortion</span><span class=o>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>latch</span> <span class=o>=</span> <span class=n>latch</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>doWork</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to exit
</span><span class=c1></span>            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
                <span class=n>latch</span><span class=o>.</span><span class=na>countDown</span><span class=o>();</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=kt>void</span> <span class=nf>doWork</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
            <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>2000</span><span class=o>));</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34;completed&#34;</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;%1$-3d &#34;</span><span class=o>,</span> <span class=n>id</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=cm>/** Waits on the CountDownLatch: */</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>WaitingTask</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>;</span>

        <span class=n>WaitingTask</span><span class=o>(</span><span class=n>CountDownLatch</span> <span class=n>latch</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>latch</span> <span class=o>=</span> <span class=n>latch</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>latch</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Latch barrier passed for &#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34; interrupted&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;WaitingTask %1$-3d &#34;</span><span class=o>,</span> <span class=n>id</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>SIZE</span> <span class=o>=</span> <span class=n>10</span><span class=o>;</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>ExecutorService</span> <span class=n>exec</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=c1>// 所有任务都必须使用同一个CountDownLatch对象
</span><span class=c1></span>        <span class=n>CountDownLatch</span> <span class=n>latch</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CountDownLatch</span><span class=o>(</span><span class=n>SIZE</span><span class=o>);</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>WaitingTask</span><span class=o>(</span><span class=n>latch</span><span class=o>));</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>TaskPortion</span><span class=o>(</span><span class=n>latch</span><span class=o>));</span>
        <span class=o>}</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Launched all tasks&#34;</span><span class=o>);</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span> <span class=c1>// Quit when all tasks complete
</span><span class=c1></span>    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output (sample)
</span><span class=cm>Launched all tasks
</span><span class=cm>7   completed
</span><span class=cm>9   completed
</span><span class=cm>5   completed
</span><span class=cm>8   completed
</span><span class=cm>1   completed
</span><span class=cm>2   completed
</span><span class=cm>6   completed
</span><span class=cm>4   completed
</span><span class=cm>0   completed
</span><span class=cm>3   completed
</span><span class=cm>Latch barrier passed for WaitingTask 0  
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>上面的示例中，WaitingTask将会阻塞，直到所有的TaskPortion执行完成，TaskPortion完成之后调用了<code>countDown()</code>方法，注意，<code>countDown()</code>方法是在finally块中调用的，这是为了防止TaskPortion出现异常而导致任务一直阻塞。当计数器为0后，我们看到WaitingTask成功执行。</p>
<p><code>await()</code>还有一个重载方法<code>await(long, TimeUnit)</code>，避免任务让线程一直等待。</p>
<h1 id=2-cyclicbarrier>2 CyclicBarrier</h1>
<p>CyclicBarrier被称为“同步屏障”，事实上就可以把它理解为一个屏障，多个任务调用屏障的<code>await()</code>方法将被阻塞，直到所有的任务都进入阻塞，那么屏障开启，所有任务继续执行。这看起来和CountDownLatch非常像，不过CountDownLatch只能触发一次，而CyclicBarrier可以多次重用，这是它们的主要区别之一。</p>
<p>和CountDownLatch一样，CyclicBarrier接受一个整型参数，表示可限制的线程数。除此之外，CyclicBarrier还可以接受一个Runnable作为参数，这个参数称作<code>barrierAction</code>，<code>barrierAction</code>在所有线程到达屏障之后即开始执行，其他任务<strong>只能等待</strong><code>barrierAction</code>执行完毕之后才能继续执行，这是CyclicBarrier和CountDownLatch的区别之二。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestCyclicBarrier</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=n>StringBuffer</span> <span class=n>sb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuffer</span><span class=o>();</span>
    <span class=cm>/** CyclicBarrier的构造器任务总是会先执行完毕 */</span>
    <span class=kd>static</span> <span class=n>CyclicBarrier</span> <span class=n>c</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=o>(</span><span class=n>2</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
        <span class=n>sb</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>3</span><span class=o>);</span>
    <span class=o>});</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ASSERT_VALUE</span> <span class=o>=</span> <span class=n>312</span><span class=o>;</span>

    <span class=kd>static</span> <span class=kt>int</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>Thread</span> <span class=n>t</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Thread</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>c</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// ignore;
</span><span class=c1></span>            <span class=o>}</span>
            <span class=n>sb</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
        <span class=o>});</span>
        <span class=n>t</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>c</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
            <span class=n>sb</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
            <span class=n>t</span><span class=o>.</span><span class=na>join</span><span class=o>();</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=c1>// ignore
</span><span class=c1></span>        <span class=o>}</span>
        <span class=k>return</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>sb</span><span class=o>.</span><span class=na>toString</span><span class=o>())</span> <span class=o>|</span> <span class=o>(</span><span class=n>sb</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>sb</span><span class=o>.</span><span class=na>length</span><span class=o>())).</span><span class=na>length</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>

        <span class=k>for</span> <span class=o>(;</span> <span class=o>;</span> <span class=o>)</span> <span class=o>{</span>
            <span class=kt>int</span> <span class=n>r</span><span class=o>;</span>
            <span class=k>if</span> <span class=o>((</span><span class=n>r</span> <span class=o>=</span> <span class=n>run</span><span class=o>())</span> <span class=o>!=</span> <span class=n>ASSERT_VALUE</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// should be 321
</span><span class=c1></span>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>r</span><span class=o>);</span>
                <span class=k>return</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>上例中，barrier有一个<code>barrierAction</code>和2个“屏障任务”，main方法的输出大概率为312，小概率为321，不会出现其他结果，所以main方法无论执行多长时间，其总会结束。由于<code>barrierAction</code>总是先执行，故结果总是3xx<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，其先执行完毕的原因在源码中很容易找到：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=c1>//...
</span><span class=c1>// 所有任务到达屏障
</span><span class=c1></span><span class=k>if</span> <span class=o>(</span><span class=n>index</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>  <span class=c1>// tripped
</span><span class=c1></span><span class=kt>boolean</span> <span class=n>ranAction</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
<span class=k>try</span> <span class=o>{</span>
    <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>command</span> <span class=o>=</span> <span class=n>barrierCommand</span><span class=o>;</span>
    <span class=c1>//直接在当前线程调用command的run方法
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>command</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
        <span class=n>command</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
    <span class=n>ranAction</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
    <span class=n>nextGeneration</span><span class=o>();</span>
    <span class=k>return</span> <span class=n>0</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(!</span><span class=n>ranAction</span><span class=o>)</span>
            <span class=n>breakBarrier</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=c1>//...
</span></code></pre></td></tr></table>
</div>
</div><p>不过，屏障开启后，任务的执行顺序完全是由cpu调度的。同时，本例中的CyclicBarrier是静态域，在main方法重复执行时，并不会重新初始化，因此也直接证明了CyclicBarrier的可重用性——屏障开启后，任务继续执行后调用屏障的<code>await()</code>方法同样会阻塞而等待所有任务到达屏障，依次循环。</p>
<p>下例的“赛马游戏”<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>完美地阐述了CyclicBarrier可以多次重用的特点，马每次跑一步，不过不同的马步长不同，等待所有的马都“跑出这一步”后，屏障开启，先确定是否有马到达终点，如有则结束赛跑，否则继续下一轮，直到有马越过终点线，下面是示例代码</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HorseRace</span> <span class=o>{</span>

    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Horse</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kt>int</span> <span class=n>strides</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=n>47</span><span class=o>);</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>Horse</span><span class=o>(</span><span class=n>CyclicBarrier</span> <span class=n>b</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>barrier</span> <span class=o>=</span> <span class=n>b</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=kd>public</span> <span class=kt>int</span> <span class=nf>getStrides</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>strides</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span> <span class=o>{</span>
                    <span class=n>strides</span> <span class=o>+=</span> <span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>3</span><span class=o>);</span> <span class=c1>// Produces 0, 1 or 2
</span><span class=c1></span>                    <span class=n>barrier</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
                <span class=o>}</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// A legitimate way to exit
</span><span class=c1></span>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>BrokenBarrierException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// This one we want to know about
</span><span class=c1></span>                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;Horse &#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34; &#34;</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=kd>public</span> <span class=n>String</span> <span class=nf>tracks</span><span class=o>()</span> <span class=o>{</span>
            <span class=n>StringBuilder</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>getStrides</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                <span class=n>s</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;*&#34;</span><span class=o>);</span>
            <span class=o>}</span>
            <span class=n>s</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
            <span class=k>return</span> <span class=n>s</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>FINISH_LINE</span> <span class=o>=</span> <span class=n>20</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Horse</span><span class=o>&gt;</span> <span class=n>horses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
    <span class=kd>private</span> <span class=n>ExecutorService</span> <span class=n>exec</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
    <span class=kd>private</span> <span class=n>CyclicBarrier</span> <span class=n>barrier</span><span class=o>;</span>

    <span class=cm>/** 这是一构造器 */</span>
    <span class=kd>public</span> <span class=nf>HorseRace</span><span class=o>(</span><span class=kt>int</span> <span class=n>nHorses</span><span class=o>,</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>pause</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>barrier</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=o>(</span><span class=n>nHorses</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
            <span class=n>StringBuilder</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>FINISH_LINE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                <span class=n>s</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=s>&#34;=&#34;</span><span class=o>);</span> <span class=c1>// The fence on the racetrack
</span><span class=c1></span>            <span class=o>}</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>s</span><span class=o>);</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>Horse</span> <span class=n>horse</span> <span class=o>:</span> <span class=n>horses</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>horse</span><span class=o>.</span><span class=na>tracks</span><span class=o>());</span>
            <span class=o>}</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>Horse</span> <span class=n>horse</span> <span class=o>:</span> <span class=n>horses</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>horse</span><span class=o>.</span><span class=na>getStrides</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>FINISH_LINE</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>horse</span> <span class=o>+</span> <span class=s>&#34;won!&#34;</span><span class=o>);</span>
                    <span class=n>exec</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
                    <span class=k>return</span><span class=o>;</span>
                <span class=o>}</span>
            <span class=o>}</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>pause</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;barrier-action sleep interrupted&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>});</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>nHorses</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=n>Horse</span> <span class=n>horse</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Horse</span><span class=o>(</span><span class=n>barrier</span><span class=o>);</span>
            <span class=n>horses</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>horse</span><span class=o>);</span>
            <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>horse</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=kt>int</span> <span class=n>nHorses</span> <span class=o>=</span> <span class=n>7</span><span class=o>;</span>
        <span class=kt>int</span> <span class=n>pause</span> <span class=o>=</span> <span class=n>200</span><span class=o>;</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Optional argument
</span><span class=c1></span>            <span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Integer</span><span class=o>(</span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]);</span>
            <span class=n>nHorses</span> <span class=o>=</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>?</span> <span class=n>n</span> <span class=o>:</span> <span class=n>nHorses</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>args</span><span class=o>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Optional argument
</span><span class=c1></span>            <span class=kt>int</span> <span class=n>p</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Integer</span><span class=o>(</span><span class=n>args</span><span class=o>[</span><span class=n>1</span><span class=o>]);</span>
            <span class=n>pause</span> <span class=o>=</span> <span class=n>p</span> <span class=o>&gt;</span> <span class=o>-</span><span class=n>1</span> <span class=o>?</span> <span class=n>p</span> <span class=o>:</span> <span class=n>pause</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=k>new</span> <span class=n>HorseRace</span><span class=o>(</span><span class=n>nHorses</span><span class=o>,</span> <span class=n>pause</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>实际上程序通过获取每匹马的<code>strides</code>域来判断马是否到达终点。在TIJ原书中，对<code>strides</code>域的有关操作做了同步处理，而本例中移除了这些同步，这是否安全？虽然CyclicBarrier的<code>barrierAction</code>和<code>HorseRace</code>都访问了<code>strides</code>域，不过，二者访问域的时间一定是错开的：前者在所有马都到达屏障后开始访问，而此时的马处于阻塞状态，而马获得访问权时，<code>barrierAction</code>一定没在执行。因此本例中，不使用同步也是安全的。</p>
<p>CyclicBarrier还有一些特殊方法</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>reset</span><span class=o>();</span>
    <span class=n>这个方法将CyclicBarrier重置到初始状态</span>
    <span class=n>注意</span><span class=err>，</span><span class=n>这个方法会导致已经在屏障处等待的线程抛出BrokenBarrierException</span>
    <span class=n>如果确实需要一个新的CyclicBarrier来执行操作</span><span class=err>，</span><span class=n>新建一个实例是更好的选择</span>

<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getNumberWaiting</span><span class=o>()</span> <span class=o>;</span>
    <span class=n>这个方法获取在屏障等待的线程数</span>

<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getParties</span><span class=o>()</span> <span class=o>;</span>
    <span class=n>这个方法获取所有的线程数</span><span class=err>（</span><span class=n>用来构建CyclicBarrier实例的int入参</span><span class=err>）</span>
</code></pre></td></tr></table>
</div>
</div><p>下面的例子展示了在任务执行时重置CyclicBarrier的操作，这个示例只是为了展示上面几个方法的用法，<strong>千万不要</strong>在执行任务时贸然去做这样的操作！如果处理不得当将很大可能引发阻塞或其他并发问题。</p>
<blockquote>
<p>笔者本意是计划执行批量任务，这些任务有一个域来计算其运行次数，并可能在某个任务上调用<code>reset()</code>方法，在<code>reset()</code>调用之前和之后的任务其运行次数会有差别，通过这个运行差异在<code>barrierAction</code>中来终结线程池。事实上这个预想完全落空了，<code>reset()</code>之后，如果不再次使所有线程重新到达屏障处等待，<code>barrierAction</code>就不可能执行</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResetCyclicBarrier</span> <span class=o>{</span>
    <span class=kd>static</span> <span class=kt>void</span> <span class=nf>reSetBarrierIf</span><span class=o>(</span><span class=kt>int</span> <span class=n>parties</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bound</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>TaskMayFail</span><span class=o>[]</span> <span class=n>tasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TaskMayFail</span><span class=o>[</span><span class=n>parties</span><span class=o>];</span>
        <span class=n>ThreadPoolExecutor</span> <span class=n>exec</span> <span class=o>=</span> <span class=o>(</span><span class=n>ThreadPoolExecutor</span><span class=o>)</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>setKeepAliveTime</span><span class=o>(</span><span class=n>0</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
        <span class=n>AtomicInteger</span> <span class=n>ai</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>
        <span class=n>CyclicBarrier</span> <span class=n>c2</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CyclicBarrier</span><span class=o>(</span><span class=n>parties</span><span class=o>,</span> <span class=o>()</span> <span class=o>-&gt;</span> <span class=o>{</span>
            <span class=c1>// if reset barrier while task is running, the
</span><span class=c1></span>            <span class=c1>// barrier action can not reach in this cycle
</span><span class=c1></span>            <span class=c1>// until relaunch all parties to reach at barrier
</span><span class=c1></span>            <span class=c1>// in next round
</span><span class=c1></span>            <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
            <span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>runtime</span><span class=o>;</span>
            <span class=k>while</span> <span class=o>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>parties</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>r</span> <span class=o>!=</span> <span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>runtime</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>runtime</span> <span class=o>+</span> <span class=s>&#34;: &#34;</span> <span class=o>+</span> <span class=n>r</span><span class=o>);</span>
                    <span class=n>exec</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
                    <span class=k>return</span><span class=o>;</span>
                <span class=o>}</span>
                <span class=n>r</span> <span class=o>=</span> <span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>].</span><span class=na>runtime</span><span class=o>;</span>
                <span class=n>i</span><span class=o>++;</span>
            <span class=o>}</span>
        <span class=o>});</span>

        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>parties</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=n>TaskMayFail</span> <span class=n>taskMayFail</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TaskMayFail</span><span class=o>(</span><span class=n>c2</span><span class=o>,</span> <span class=n>ai</span><span class=o>,</span> <span class=n>bound</span><span class=o>);</span>
            <span class=n>tasks</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>taskMayFail</span><span class=o>;</span>
            <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>taskMayFail</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>TaskMayFail</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>static</span> <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
        <span class=kd>static</span> <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span>
        <span class=kd>final</span> <span class=n>CyclicBarrier</span> <span class=n>cb</span><span class=o>;</span>
        <span class=kd>final</span> <span class=n>AtomicInteger</span> <span class=n>reSetCount</span><span class=o>;</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>bound</span><span class=o>;</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>count</span><span class=o>++;</span>
        <span class=kt>int</span> <span class=n>runtime</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>


        <span class=kd>public</span> <span class=nf>TaskMayFail</span><span class=o>(</span><span class=n>CyclicBarrier</span> <span class=n>cb</span><span class=o>,</span> <span class=n>AtomicInteger</span> <span class=n>reSetCount</span><span class=o>,</span> <span class=kt>int</span> <span class=n>bound</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>reSetCount</span> <span class=o>=</span> <span class=n>reSetCount</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>bound</span> <span class=o>=</span> <span class=n>bound</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;[TaskMayFail-&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;-runtime-&#34;</span> <span class=o>+</span> <span class=n>runtime</span> <span class=o>+</span> <span class=s>&#34;]&#34;</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>isInterrupted</span><span class=o>())</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextBoolean</span><span class=o>())</span> <span class=o>{</span>
                        <span class=c1>// bound值可调整reset的概率
</span><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>bound</span><span class=o>)</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
                            <span class=k>throw</span> <span class=k>new</span> <span class=n>ArithmeticException</span><span class=o>();</span>
                        <span class=o>}</span>
                    <span class=o>}</span>
                    <span class=n>runtime</span><span class=o>++;</span>
                    <span class=n>cb</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
                <span class=o>}</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>ArithmeticException</span> <span class=n>ae</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>reSetCount</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
                <span class=k>while</span> <span class=o>(</span><span class=n>cb</span><span class=o>.</span><span class=na>getNumberWaiting</span><span class=o>()</span> <span class=o>&lt;</span> <span class=o>(</span><span class=n>cb</span><span class=o>.</span><span class=na>getParties</span><span class=o>()</span> <span class=o>-</span> <span class=n>reSetCount</span><span class=o>.</span><span class=na>intValue</span><span class=o>()))</span> <span class=o>{</span>
                    <span class=c1>// waiting for all parties reach at barrier
</span><span class=c1></span>                    <span class=c1>// or all parties throws exception
</span><span class=c1></span>                <span class=o>}</span>
                <span class=c1>// reset barrier
</span><span class=c1></span>                <span class=n>cb</span><span class=o>.</span><span class=na>reset</span><span class=o>();</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s-%s reset %s%n&#34;</span><span class=o>,</span>
                    <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
                    <span class=k>this</span><span class=o>,</span>
                    <span class=n>cb</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=o>|</span> <span class=n>BrokenBarrierException</span> <span class=n>ae</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>reSetCount</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
                <span class=c1>// once barrier reset, other parties wait on barrier
</span><span class=c1></span>                <span class=c1>// will throw BrokenBarrierException
</span><span class=c1></span>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s-%s return by broken barrier.%n&#34;</span><span class=o>,</span>
                    <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>getName</span><span class=o>(),</span>
                    <span class=k>this</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
                <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>().</span><span class=na>interrupt</span><span class=o>();</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>reSetBarrierIf</span><span class=o>(</span><span class=n>13</span><span class=o>,</span> <span class=n>100</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output (sample)
</span><span class=cm>pool-1-thread-3-[TaskMayFail-3-runtime-19] reset java.util.concurrent.CyclicBarrier@618bfe9a
</span><span class=cm>pool-1-thread-4-[TaskMayFail-4-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-9-[TaskMayFail-9-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-8-[TaskMayFail-8-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-5-[TaskMayFail-5-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-12-[TaskMayFail-12-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-7-[TaskMayFail-7-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-13-[TaskMayFail-13-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-1-[TaskMayFail-1-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-11-[TaskMayFail-11-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-2-[TaskMayFail-2-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-10-[TaskMayFail-10-runtime-20] return by broken barrier.
</span><span class=cm>pool-1-thread-6-[TaskMayFail-6-runtime-19] reset java.util.concurrent.CyclicBarrier@618bfe9a
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>从输出可以看到，CyclicBarrier可以重复使用。上例的设计很巧妙，因为屏障在开启之后，任务可能很快就进入抛出<code>ArithmeticException</code>而进入<code>reset</code>流程，而此时其他任务可能在屏障处等待或者还未执行，若此时贸然reset，那些等待的线程会抛出<code>BrokenBarrierException</code>并退出，但是未执行的线程并未意识到reset的发生（可以这么表述），依然进入阻塞，如果没有再次任务进入<code>reset</code>流程，程序很快将因为没有足够多的线程到达屏障而阻塞<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>。</p>
<p>所以，上例引入一个原子变量，用于跟踪进入reset和已经退出的任务数，那么剩余的线程应该就是到达屏障的线程数，利用这个限制来保证<strong>所有的线程都得到处理</strong>，以简化问题的复杂性，一旦确定所有的线程都被处理，就可以执行<code>reset()</code>方法。同时<code>reset()</code>之后，<code>barrierAction</code>便无法执行。</p>
<h1 id=3-semaphore>3 Semaphore</h1>
<p>无论是显式锁还是通过synchronized关键字获取的隐式锁，其在任一时刻都只能让一个任务访问资源，而Semaphore（计数信号量）允许多个任务同时访问资源。可以把Semaphore看作是持有对象访问许可（permits）的“security”。访问对象时，须先通过<code>acquire()</code>获取许可，若此时没有许可可用，那么<code>acquire()</code>将阻塞，否则获取许可，可用许可数-1；使用完资源后，通过<code>release()</code>方法返还许可。事实上，并没有实际上的许可证对象，Semaphore通过协同各个线程工作，来达到目的。</p>
<p>Semaphore的构造器接受一个“公平性参数”。不传入此参数或传入<i>false</i>时，线程获取许可的顺序无法保证，即使线程阻塞了很久，其仍然可能被刚调用<code>acquire()</code>方法的线程“抢走”许可，这可能会导致线程“饿死”。当传入<i>true</i>时，Semphore保证线程获取许可的顺序和其调用<code>acquire()</code>方法之后被执行的顺序一致<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>，也就是先执行的任务先获取许可（FIFO）。需要说明的是，<code>tryAcquire()</code>方法不遵循公平性原则，如果有许可可用，它直接获取之。在使用Semaphore时，一般将其设置为<strong>公平</strong>的</p>
<p>Semaphore通常用于限制访问资源的线程数量，典型的例子就是控制“池”的并发访问量。下例中使用Semaphore控制池中的对象方法，当需要使用时，可以将它们“签出”（checkout），使用完毕之后再将其“签入”（checkin），使用泛型类封装功能<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>class</span> <span class=nc>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>
    <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>items</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span><span class=o>[]</span> <span class=n>checkedOut</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Semaphore</span> <span class=n>available</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>Pool</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>classObject</span><span class=o>,</span> <span class=kt>int</span> <span class=n>size</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>size</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
        <span class=n>checkedOut</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>boolean</span><span class=o>[</span><span class=n>size</span><span class=o>];</span>
        <span class=n>available</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Semaphore</span><span class=o>(</span><span class=n>size</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
        <span class=c1>// Load pool with objects that can be checked out:
</span><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=c1>// Assumes a default constructor:
</span><span class=c1></span>                <span class=n>items</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>classObject</span><span class=o>.</span><span class=na>newInstance</span><span class=o>());</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=n>T</span> <span class=nf>checkOut</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
        <span class=n>available</span><span class=o>.</span><span class=na>acquire</span><span class=o>();</span>
        <span class=k>return</span> <span class=n>getItem</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kt>void</span> <span class=nf>checkIn</span><span class=o>(</span><span class=n>T</span> <span class=n>x</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>releaseItem</span><span class=o>(</span><span class=n>x</span><span class=o>))</span> <span class=o>{</span>
            <span class=n>available</span><span class=o>.</span><span class=na>release</span><span class=o>();</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;release &#34;</span> <span class=o>+</span> <span class=n>x</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kt>void</span> <span class=nf>checkAllIn</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>available</span><span class=o>.</span><span class=na>release</span><span class=o>(</span><span class=n>releaseAll</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>T</span> <span class=nf>getItem</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(!</span><span class=n>checkedOut</span><span class=o>[</span><span class=n>i</span><span class=o>])</span> <span class=o>{</span>
                <span class=n>checkedOut</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
                <span class=k>return</span> <span class=n>items</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=c1>// Semaphore prevents reaching here
</span><span class=c1></span>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>releaseItem</span><span class=o>(</span><span class=n>T</span> <span class=n>item</span><span class=o>)</span> <span class=o>{</span>
        <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>items</span><span class=o>.</span><span class=na>indexOf</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>index</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span> <span class=c1>// Not in the list
</span><span class=c1></span>        <span class=o>}</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>checkedOut</span><span class=o>[</span><span class=n>index</span><span class=o>])</span> <span class=o>{</span>
            <span class=n>checkedOut</span><span class=o>[</span><span class=n>index</span><span class=o>]</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>

            <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=c1>// Wasn&#39;t checked out
</span><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>releaseAll</span><span class=o>()</span> <span class=o>{</span>
        <span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>items</span><span class=o>.</span><span class=na>size</span><span class=o>();</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>checkedOut</span><span class=o>[</span><span class=n>i</span><span class=o>])</span> <span class=o>{</span>
                <span class=n>checkedOut</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
                <span class=o>++</span><span class=n>r</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=n>r</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个池使用<code>checkout</code>和<code>checkIn</code>方法来签出和签入对象，在签出对象之前调用<code>acquire()</code>，如果没有可用对象，那么<code>checkOut</code>将阻塞。由于Semaphore的机制，<code>checkOut</code>方法并不需要使用同步，但是<code>getItem</code>方法则需要同步了，Semaphore协同多线程对资源的访问，但是并不能保证多线程对资源修改的并发安全，这是两回事<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>。<code>checkIn</code>方法则判断给定对象是否被使用，是则签入之，否则不做任何操作，同样的，<code>releaseItem</code>方法也需要使用同步。</p>
<blockquote>
<p><em>The semaphore encapsulates the synchronization needed to restrict access to the pool, separately from<br>
any synchronization needed to maintain the consistency of the pool itself.</em></p>
</blockquote>
<p>接下来我们可以测试这个池能否正常工作了:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SemaphoreDemo</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>AcquireTask</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>AcquireTask</span><span class=o>(</span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>pool</span> <span class=o>=</span> <span class=n>pool</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>T</span> <span class=n>item</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>checkOut</span><span class=o>();</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34; acquire &#34;</span> <span class=o>+</span> <span class=n>item</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to terminate
</span><span class=c1></span>            <span class=o>}</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;CheckoutTask-&#34;</span> <span class=o>+</span> <span class=n>id</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>ReleaseTask</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>ReleaseTask</span><span class=o>(</span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>pool</span> <span class=o>=</span> <span class=n>pool</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>items</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>items</span><span class=o>;</span>
                <span class=k>for</span> <span class=o>(</span><span class=n>T</span> <span class=n>item</span> <span class=o>:</span> <span class=n>items</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>pool</span><span class=o>.</span><span class=na>checkIn</span><span class=o>(</span><span class=n>item</span><span class=o>);</span>
                <span class=o>}</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to terminate
</span><span class=c1></span>            <span class=o>}</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;AcquireTask-&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34; &#34;</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Fat</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>double</span> <span class=n>d</span><span class=o>;</span> <span class=c1>// Prevent optimization
</span><span class=c1></span>        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>

        <span class=kd>public</span> <span class=nf>Fat</span><span class=o>()</span> <span class=o>{</span>
            <span class=c1>// Expensive, interruptible operation:
</span><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>1</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                <span class=n>d</span> <span class=o>+=</span> <span class=o>(</span><span class=n>Math</span><span class=o>.</span><span class=na>PI</span> <span class=o>+</span> <span class=n>Math</span><span class=o>.</span><span class=na>E</span><span class=o>)</span> <span class=o>/</span> <span class=o>(</span><span class=kt>double</span><span class=o>)</span> <span class=n>i</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;Fat-&#34;</span> <span class=o>+</span> <span class=n>id</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>final</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>SIZE</span> <span class=o>=</span> <span class=n>5</span><span class=o>;</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>test</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
        <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>pool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Pool</span><span class=o>&lt;&gt;(</span><span class=n>Fat</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>SIZE</span><span class=o>);</span>
        <span class=n>ExecutorService</span> <span class=n>exec</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>AcquireTask</span><span class=o>&lt;&gt;(</span><span class=n>pool</span><span class=o>));</span>
        <span class=o>}</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>ReleaseTask</span><span class=o>&lt;&gt;(</span><span class=n>pool</span><span class=o>));</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>list</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>SIZE</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
            <span class=n>Fat</span> <span class=n>f</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>checkOut</span><span class=o>();</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>i</span> <span class=o>+</span> <span class=s>&#34;: main() acquire &#34;</span> <span class=o>+</span> <span class=n>f</span><span class=o>);</span>
            <span class=n>list</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>f</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=n>Future</span><span class=o>&lt;?&gt;</span> <span class=n>blocked</span> <span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=na>submit</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=c1>// Semaphore prevents additional checkout,
</span><span class=c1></span>                <span class=c1>// so call is blocked:
</span><span class=c1></span>                <span class=n>pool</span><span class=o>.</span><span class=na>checkOut</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;checkOut() Interrupted&#34;</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>});</span>
        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
        <span class=n>blocked</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span> <span class=c1>// Break out of blocked call
</span><span class=c1></span>        <span class=c1>// release all items
</span><span class=c1></span>        <span class=n>pool</span><span class=o>.</span><span class=na>checkAllIn</span><span class=o>();</span>
        <span class=k>for</span> <span class=o>(</span><span class=n>Fat</span> <span class=n>f</span> <span class=o>:</span> <span class=n>list</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>pool</span><span class=o>.</span><span class=na>checkIn</span><span class=o>(</span><span class=n>f</span><span class=o>);</span> <span class=c1>// Second checkIn ignored
</span><span class=c1></span>        <span class=o>}</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=n>SemaphoreDemo</span> <span class=n>semaphoreDemo</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SemaphoreDemo</span><span class=o>();</span>
        <span class=n>semaphoreDemo</span><span class=o>.</span><span class=na>test</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output(sample)
</span><span class=cm>AcquireTask-0 acquire Fat-0
</span><span class=cm>AcquireTask-4 acquire Fat-4
</span><span class=cm>AcquireTask-3 acquire Fat-3
</span><span class=cm>AcquireTask-2 acquire Fat-2
</span><span class=cm>AcquireTask-1 acquire Fat-1
</span><span class=cm>release Fat-0
</span><span class=cm>0: main() acquire Fat-0
</span><span class=cm>release Fat-1
</span><span class=cm>1: main() acquire Fat-1
</span><span class=cm>release Fat-2
</span><span class=cm>2: main() acquire Fat-2
</span><span class=cm>release Fat-3
</span><span class=cm>3: main() acquire Fat-3
</span><span class=cm>release Fat-4
</span><span class=cm>4: main() acquire Fat-4
</span><span class=cm>checkOut() Interrupted
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>上例<code>SemaphoreDemo</code>有两个任务，分别用于签入签出对象，程序首先使用<code>AcquireTask</code>签出所有对象，接着使用<code>ReleaseTask</code>签入对象。主线程接着依次签出所有对象，可以看到，主线程的签出过程是被阻塞的，只有对象签入之后，才能被签出。主线程签出所有对象之后，由于没有签入任务，接着的签出任务一定是被阻塞的，主线程休眠2s后中断了阻塞的任务。</p>
<h1 id=4-exchanger>4 Exchanger</h1>
<p>Exchanger是在两个任务之间交换对象的栅栏。当这些任务进入栅栏时，各自拥有一个对象，离开时交换它们拥有的对象。栅栏可以用来设计缓存对象，2个任务分别来使用和清空缓存，当缓存空间满时，则在Exchanger上交换缓存，缓存得以重复使用<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>buffer</span><span class=o>;</span>
    <span class=cm>/** 利用size构造一个有界队列 */</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>size</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>DataBuffer</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>cls</span><span class=o>,</span> <span class=kt>int</span> <span class=n>size</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>(</span><span class=n>cls</span><span class=o>,</span> <span class=n>size</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=nf>DataBuffer</span><span class=o>(</span><span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>cls</span><span class=o>,</span> <span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=n>Generator</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>gen</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>cls</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>();</span>
        <span class=c1>// 检查cls的类型，如果不是队列，则抛出异常
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>Queue</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>isAssignableFrom</span><span class=o>(</span><span class=n>cls</span><span class=o>))</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>ClassCastException</span><span class=o>();</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>();</span>
        <span class=k>this</span><span class=o>.</span><span class=na>size</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>Constructor</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>c</span> <span class=o>=</span> <span class=n>cls</span><span class=o>.</span><span class=na>getConstructor</span><span class=o>(</span><span class=kt>int</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
            <span class=n>c</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
            <span class=k>this</span><span class=o>.</span><span class=na>buffer</span> <span class=o>=</span> <span class=n>c</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=n>size</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchMethodException</span> <span class=o>|</span> <span class=n>SecurityException</span> <span class=o>|</span> <span class=n>InvocationTargetException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>buffer</span> <span class=o>=</span> <span class=n>cls</span><span class=o>.</span><span class=na>newInstance</span><span class=o>();</span>
        <span class=o>}</span>

        <span class=k>if</span> <span class=o>(</span><span class=n>gen</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span>
                <span class=n>buffer</span><span class=o>.</span><span class=na>offer</span><span class=o>(</span><span class=n>gen</span><span class=o>.</span><span class=na>next</span><span class=o>());</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>isFull</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>size</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>isEmpty</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=kt>int</span> <span class=nf>bufferSize</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>size</span><span class=o>();</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=kd>public</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>getBuffer</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>buffer</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>addToBuffer</span><span class=o>(</span><span class=n>T</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(!</span><span class=n>isFull</span><span class=o>())</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>offer</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>synchronized</span> <span class=n>T</span> <span class=nf>takeFromBuffer</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(!</span><span class=n>isEmpty</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>buffer</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
        <span class=o>}</span>
        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>DataBuffer</code>接受一个<code>Queue&lt;T></code>类型参数，用来初始化缓存队列，并且利用size指定了缓存队列的容量，作为是“达到栅栏”的前置条件。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BufferSwap</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>class</span> <span class=nc>FillTask</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>db</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Exchanger</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>ex</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Generator</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>gen</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>FillTask</span><span class=o>(</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>db</span><span class=o>,</span> <span class=n>Generator</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>gen</span><span class=o>,</span> <span class=n>Exchanger</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>db</span> <span class=o>=</span> <span class=n>db</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>gen</span> <span class=o>=</span> <span class=n>gen</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>ex</span> <span class=o>=</span> <span class=n>ex</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(</span><span class=n>db</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>db</span><span class=o>.</span><span class=na>isFull</span><span class=o>())</span> <span class=o>{</span>
                        <span class=n>db</span> <span class=o>=</span> <span class=n>ex</span><span class=o>.</span><span class=na>exchange</span><span class=o>(</span><span class=n>db</span><span class=o>);</span>
                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                        <span class=n>db</span><span class=o>.</span><span class=na>addToBuffer</span><span class=o>(</span><span class=n>gen</span><span class=o>.</span><span class=na>next</span><span class=o>());</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// right to exit here
</span><span class=c1></span>            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kd>class</span> <span class=nc>EmptyTask</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>

        <span class=kd>private</span> <span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>db</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Exchanger</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>ex</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>ecLimit</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>EmptyTask</span><span class=o>(</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>db</span><span class=o>,</span> <span class=n>Exchanger</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>ex</span><span class=o>,</span> <span class=kt>int</span> <span class=n>limit</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>db</span> <span class=o>=</span> <span class=n>db</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>ex</span> <span class=o>=</span> <span class=n>ex</span><span class=o>;</span>
            <span class=k>this</span><span class=o>.</span><span class=na>ecLimit</span> <span class=o>=</span> <span class=n>limit</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(</span><span class=n>ec</span><span class=o>.</span><span class=na>intValue</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>ecLimit</span><span class=o>)</span> <span class=o>{</span>
                    <span class=k>if</span> <span class=o>(</span><span class=n>db</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
                        <span class=n>db</span> <span class=o>=</span> <span class=n>ex</span><span class=o>.</span><span class=na>exchange</span><span class=o>(</span><span class=n>db</span><span class=o>);</span>
                        <span class=n>ec</span><span class=o>.</span><span class=na>incrementAndGet</span><span class=o>();</span>
                    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                        <span class=n>db</span><span class=o>.</span><span class=na>takeFromBuffer</span><span class=o>();</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// exit by interrupted
</span><span class=c1></span>            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=cm>/** 交换缓存的次数，用来限制程序的运行 */</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>AtomicInteger</span> <span class=n>ec</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>();</span>

    <span class=cm>/**
</span><span class=cm>     * @param size  the buffer size
</span><span class=cm>     * @param limit the exchange time limit
</span><span class=cm>     */</span>
    <span class=kt>void</span> <span class=nf>test</span><span class=o>(</span><span class=kt>int</span> <span class=n>size</span><span class=o>,</span> <span class=kt>int</span> <span class=n>limit</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>Exchanger</span><span class=o>&lt;</span><span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;&gt;</span> <span class=n>xh</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Exchanger</span><span class=o>&lt;&gt;();</span>
        <span class=n>Generator</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>generator</span> <span class=o>=</span> <span class=n>BasicGenerator</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=n>Fat</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
        <span class=c1>// ignore class check
</span><span class=c1></span>        <span class=c1>// can not solve the issue actually...
</span><span class=c1></span>        <span class=n>DataBuffer</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>fullBuffer</span><span class=o>,</span> <span class=n>emptyBuffer</span><span class=o>;</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>fullBuffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataBuffer</span><span class=o>(</span><span class=n>ArrayBlockingQueue</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>size</span><span class=o>,</span> <span class=n>generator</span><span class=o>);</span>
            <span class=n>emptyBuffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataBuffer</span><span class=o>(</span><span class=n>ArrayBlockingQueue</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>size</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;initialization failure&#34;</span><span class=o>);</span>
            <span class=k>return</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=n>ExecutorService</span> <span class=n>pool</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=n>Future</span><span class=o>&lt;?&gt;</span> <span class=n>t1</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>new</span> <span class=n>FillTask</span><span class=o>(</span><span class=n>fullBuffer</span><span class=o>,</span> <span class=n>generator</span><span class=o>,</span> <span class=n>xh</span><span class=o>));</span>
        <span class=n>Future</span><span class=o>&lt;?&gt;</span> <span class=n>done</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=na>submit</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>new</span> <span class=n>EmptyTask</span><span class=o>&lt;&gt;(</span><span class=n>emptyBuffer</span><span class=o>,</span> <span class=n>xh</span><span class=o>,</span> <span class=n>limit</span><span class=o>));</span>
        <span class=k>for</span> <span class=o>(;</span> <span class=o>;</span> <span class=o>)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>done</span><span class=o>.</span><span class=na>isDone</span><span class=o>())</span> <span class=o>{</span>
                <span class=n>t1</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
                <span class=k>break</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>pool</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
        <span class=n>Queue</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>full</span> <span class=o>=</span> <span class=n>fullBuffer</span><span class=o>.</span><span class=na>getBuffer</span><span class=o>();</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=s>&#34;fullTask&#39;s buffer: &#34;</span><span class=o>);</span>
        <span class=k>for</span> <span class=o>(</span><span class=n>Fat</span> <span class=n>fat</span> <span class=o>:</span> <span class=n>full</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s\t&#34;</span><span class=o>,</span> <span class=n>fat</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
        <span class=n>System</span><span class=o>.</span><span class=na>ocvnut</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;++++++++++++++++++++++++++++++++&#34;</span><span class=o>);</span>
        <span class=n>Queue</span><span class=o>&lt;</span><span class=n>Fat</span><span class=o>&gt;</span> <span class=n>empty</span> <span class=o>=</span> <span class=n>emptyBuffer</span><span class=o>.</span><span class=na>getBuffer</span><span class=o>();</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=s>&#34;emptyTask&#39;s buffer:&#34;</span><span class=o>);</span>
        <span class=k>for</span> <span class=o>(</span><span class=n>Fat</span> <span class=n>fat</span> <span class=o>:</span> <span class=n>empty</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s\t&#34;</span><span class=o>,</span> <span class=n>fat</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>BufferSwap</span> <span class=n>bs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferSwap</span><span class=o>();</span>
        <span class=n>bs</span><span class=o>.</span><span class=na>test</span><span class=o>(</span><span class=n>10</span><span class=o>,</span> <span class=n>100</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output
</span><span class=cm>fillTask&#39;s buffer: Fat-1000	Fat-1001	Fat-1002	Fat-1003	Fat-1004	Fat-1005	Fat-1006	Fat-1007	Fat-1008	Fat-1009
</span><span class=cm>++++++++++++++++++++++++++++++++
</span><span class=cm>emptyTask&#39;s buffer: Fat-990	Fat-991	Fat-992	Fat-993	Fat-994	Fat-995	Fat-996	Fat-997	Fat-998	Fat-999
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p><code>BufferSwap</code>中有2个任务，<code>FillTask</code>用来使用缓存，当缓存队列未满时，一直向缓存中添加对象，一旦缓存已满，则进入“栅栏”；而<code>EmptyTask</code>用来清空已满的缓存队列，知道缓存队列为空进入”栅栏”，同时为了限制缓存交换的次数，我们在缓存交换达到限制时停止<code>EmptyTask</code>。在<code>test()</code>方法中，我们初始化了2个缓存对象<code>fullBuffer</code>和<code>emptyBuffer</code>，前者会初始化一个满的缓存，后者则会初始化一个空的缓存。本例中传入的类型参数是<code>ArrayBlockingQueue.class</code>，并且忽略了类型检查<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>。</p>
<p>之后提交这2个缓存任务，使用<code>Future&lt;?></code>来检查<code>EmptyTask</code>的状态并适时取消<code>FillTask</code>。这样做时可行的，因为<code>FillTask</code>一定会在最后一次交换之后继续使用而占满缓存空间进入“栅栏”处阻塞，使用<code>Future.cancel()</code>可以中断其阻塞并抛出中断异常，从而结束运行。随后重看2个任务阻塞队列中的对象，输出符合期望<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>。</p>
<h1 id=5-priorityblockingqueue>5 PriorityBlockingQueue</h1>
<p>就是一个基础的可阻塞的<a href=../../collections/queue/#1-priorityqueue>优先级队列</a>，当队列为空时，从队列中获取元素时被阻塞。其余特性和优先级队列是一致的。</p>
<p>下例展示了如何构建一个<span id=pt>可以放入优先级队列</span>的任务：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>PrioritizedTask</span> <span class=kd>implements</span> <span class=n>Runnable</span><span class=o>,</span> <span class=n>Comparable</span><span class=o>&lt;</span><span class=n>PrioritizedTask</span><span class=o>&gt;</span> <span class=o>{</span>
    <span class=kd>protected</span> <span class=kd>static</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>PrioritizedTask</span><span class=o>&gt;</span> <span class=n>sequence</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
    <span class=kd>private</span> <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=n>47</span><span class=o>);</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>priority</span><span class=o>;</span>


    <span class=kd>public</span> <span class=nf>PrioritizedTask</span><span class=o>(</span><span class=kt>int</span> <span class=n>priority</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=o>;</span>
        <span class=n>sequence</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>compareTo</span><span class=o>(</span><span class=n>PrioritizedTask</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>priority</span> <span class=o>&lt;</span> <span class=n>arg</span><span class=o>.</span><span class=na>priority</span> <span class=o>?</span> <span class=n>1</span> <span class=o>:</span>
            <span class=o>(</span><span class=n>priority</span> <span class=o>&gt;</span> <span class=n>arg</span><span class=o>.</span><span class=na>priority</span> <span class=o>?</span> <span class=o>-</span><span class=n>1</span> <span class=o>:</span> <span class=n>0</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>try</span> <span class=o>{</span>
            <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>250</span><span class=o>));</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=c1>// Acceptable way to exit
</span><span class=c1></span>        <span class=o>}</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;[%1$-3d]&#34;</span><span class=o>,</span> <span class=n>priority</span><span class=o>)</span> <span class=o>+</span>
            <span class=s>&#34; Task &#34;</span> <span class=o>+</span> <span class=n>id</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=n>String</span> <span class=nf>summary</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>return</span> <span class=s>&#34;(&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>priority</span> <span class=o>+</span> <span class=s>&#34;)&#34;</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>EndSentinel</span> <span class=kd>extends</span> <span class=n>PrioritizedTask</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=n>ExecutorService</span> <span class=n>exec</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>EndSentinel</span><span class=o>(</span><span class=n>ExecutorService</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=kd>super</span><span class=o>(-</span><span class=n>1</span><span class=o>);</span> <span class=c1>// Lowest priority in this program
</span><span class=c1></span>            <span class=n>exec</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
            <span class=k>for</span> <span class=o>(</span><span class=n>PrioritizedTask</span> <span class=n>pt</span> <span class=o>:</span> <span class=n>sequence</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=n>pt</span><span class=o>.</span><span class=na>summary</span><span class=o>());</span>
                <span class=k>if</span> <span class=o>(++</span><span class=n>count</span> <span class=o>%</span> <span class=n>5</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>
                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
            <span class=o>}</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34; Calling shutdownNow()&#34;</span><span class=o>);</span>
            <span class=n>exec</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>PrioritizedTask</code>实现了Runnable和Comparable接口，有一个int型<code>priority</code>域，用来表示任务的优先级，在<code>compareTo</code>方法中的逻辑表示，优先级高的将会优先出队。其还有一个静态域，用来记录所有任务被置入队列的顺序。<code>PrioritizedTask</code>有一个静态内部类，也是其子类，它被称作“结束哨兵”，它的优先级为-1，代表它会最后出队，当执行这个任务时，代表任务所有的任务执行完毕，可以关闭线程池资源。</p>
<p>在接下来的示例中，将模拟生产者和消费者，执行PriorityBlockingQueue中的任务，我们可以从程序的输出观察优先级队列的出队（被执行）的顺序：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>PriorityBlockingQueueDemo</span> <span class=o>{</span>

    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>PrioritizedTaskProducer</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=n>47</span><span class=o>);</span>
        <span class=kd>private</span> <span class=n>Queue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>queue</span><span class=o>;</span>
        <span class=kd>private</span> <span class=n>ExecutorService</span> <span class=n>exec</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>PrioritizedTaskProducer</span><span class=o>(</span>
            <span class=n>Queue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>q</span><span class=o>,</span> <span class=n>ExecutorService</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>queue</span> <span class=o>=</span> <span class=n>q</span><span class=o>;</span>
            <span class=n>exec</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span> <span class=c1>// Used for EndSentinel
</span><span class=c1></span>        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=c1>// Unbounded queue; never blocks.
</span><span class=c1></span>            <span class=c1>// Fill it up fast with random priorities:
</span><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>20</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTask</span><span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>10</span><span class=o>)));</span>
                <span class=n>Thread</span><span class=o>.</span><span class=na>yield</span><span class=o>();</span>
            <span class=o>}</span>
            <span class=c1>// Trickle in highest-priority jobs:
</span><span class=c1></span>            <span class=k>try</span> <span class=o>{</span>
                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                    <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>250</span><span class=o>);</span>
                    <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTask</span><span class=o>(</span><span class=n>10</span><span class=o>));</span>
                <span class=o>}</span>
                <span class=c1>// Add jobs, lowest priority first:
</span><span class=c1></span>                <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>10</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span>
                    <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTask</span><span class=o>(</span><span class=n>i</span><span class=o>));</span>
                <span class=c1>// A sentinel to stop all the tasks:
</span><span class=c1></span>                <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTask</span><span class=o>.</span><span class=na>EndSentinel</span><span class=o>(</span><span class=n>exec</span><span class=o>));</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to exit
</span><span class=c1></span>            <span class=o>}</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Finished PrioritizedTaskProducer&#34;</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>PrioritizedTaskConsumer</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>q</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>PrioritizedTaskConsumer</span><span class=o>(</span>
            <span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>q</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span>
                    <span class=c1>// Use current thread to run the task:
</span><span class=c1></span>                    <span class=n>q</span><span class=o>.</span><span class=na>take</span><span class=o>().</span><span class=na>run</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to exit
</span><span class=c1></span>            <span class=o>}</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Finished PrioritizedTaskConsumer&#34;</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=n>ExecutorService</span> <span class=n>exec</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>queue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PriorityBlockingQueue</span><span class=o>&lt;&gt;();</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTaskProducer</span><span class=o>(</span><span class=n>queue</span><span class=o>,</span> <span class=n>exec</span><span class=o>));</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>PrioritizedTaskConsumer</span><span class=o>(</span><span class=n>queue</span><span class=o>));</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output(partial)
</span><span class=cm>[9  ] Task 5
</span><span class=cm>[9  ] Task 13
</span><span class=cm>[9  ] Task 14
</span><span class=cm>[8  ] Task 10
</span><span class=cm>... other 15 tasks
</span><span class=cm>[0  ] Task 18
</span><span class=cm>[10 ] Task 20
</span><span class=cm>... other 7 tasks
</span><span class=cm>[10 ] Task 28
</span><span class=cm>Finished PrioritizedTaskProducer
</span><span class=cm>[10 ] Task 29
</span><span class=cm>... other 9 tasks
</span><span class=cm>[0  ] Task 30
</span><span class=cm>(0:8)(1:5)(2:3)(3:1)(4:1)
</span><span class=cm>(5:9)(6:8)(7:0)(8:2)(9:7)
</span><span class=cm>(10:8)(11:8)(12:1)(13:9)(14:9)
</span><span class=cm>(15:8)(16:8)(17:1)(18:0)(19:8)
</span><span class=cm>(20:10)(21:10)(22:10)(23:10)(24:10)
</span><span class=cm>(25:10)(26:10)(27:10)(28:10)(29:10)
</span><span class=cm>(30:0)(31:1)(32:2)(33:3)(34:4)
</span><span class=cm>(35:5)(36:6)(37:7)(38:8)(39:9)
</span><span class=cm>(40:-1)
</span><span class=cm>[-1 ] Task 40 Calling shutdownNow()
</span><span class=cm>Finished PrioritizedTaskConsumer
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p><code>PrioritizedTaskProducer</code>任务负责向队列添加40个任务，前20个任务不间断地添加进队，且随机0-10的优先级；后10个任务是间隔固定时间添加优先级为10的任务，最后10个任务不间断添加优先级递增到9的任务，最后添加"结束哨兵"任务，其将打印所有任务添加到队列的顺序。<code>PrioritizedTaskConsumer</code>则是不间断的尝试从队列中取出任务执行。从输出可以看到，队列中如果有优先级高的任务，它一定是先出队的。</p>
<p>这个例子不需要任何显式同步，因为阻塞队列提供了所需的同步。</p>
<h1 id=6-delayqueue>6 DelayQueue</h1>
<p>DelayQueue是一个无界的阻塞队列，利用PriorityQueue实现，用于存放实现Delay接口<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup>的对象，队列中的对象只能在其到期之后才能被取出。同时其还是一个有序队列，即队头的元素将最先到期，若没有任何元素到期，就不会有队头元素，<code>poll()</code>方法将返回<code>null</code>，因此DelayQueue<strong>不接受</strong><code>null</code>作为元素。</p>
<p>实际上，在了解了<code>ScheduledThreadPoolExecutor.ScheduledFutureTask</code>的<a href=../%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/#4-4-%E4%BB%BB%E5%8A%A1%E5%87%BA%E9%98%9F>出队规则</a>之后，DelayQueue的出队的实现也就不言自明了——当leader被设置时，表明有任务即将出队，其他任务进入等待，该任务出队之后重置leader：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// Delayqueue.take
</span><span class=c1></span><span class=kd>public</span> <span class=n>E</span> <span class=nf>take</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
    <span class=kd>final</span> <span class=n>ReentrantLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>lock</span><span class=o>;</span>
    <span class=n>lock</span><span class=o>.</span><span class=na>lockInterruptibly</span><span class=o>();</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
            <span class=n>E</span> <span class=n>first</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=na>peek</span><span class=o>();</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>first</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
                <span class=n>available</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
            <span class=k>else</span> <span class=o>{</span>
                <span class=kt>long</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>first</span><span class=o>.</span><span class=na>getDelay</span><span class=o>(</span><span class=n>NANOSECONDS</span><span class=o>);</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>delay</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
                    <span class=k>return</span> <span class=n>q</span><span class=o>.</span><span class=na>poll</span><span class=o>();</span>
                <span class=n>first</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>// don&#39;t retain ref while waiting
</span><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
                    <span class=n>available</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
                <span class=k>else</span> <span class=o>{</span>
                    <span class=n>Thread</span> <span class=n>thisThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
                    <span class=n>leader</span> <span class=o>=</span> <span class=n>thisThread</span><span class=o>;</span>
                    <span class=k>try</span> <span class=o>{</span>
                        <span class=n>available</span><span class=o>.</span><span class=na>awaitNanos</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
                    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
                        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=n>thisThread</span><span class=o>)</span>
                            <span class=n>leader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>q</span><span class=o>.</span><span class=na>peek</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
            <span class=n>available</span><span class=o>.</span><span class=na>signal</span><span class=o>();</span>
        <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>下例展示了如何构造一个可以放入DelayQueue中的任务，这个示例的基本逻辑和<a href=#pt>PrioritizedTask</a>相当：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DelayQueueDemo</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DelayedTask</span> <span class=kd>implements</span> <span class=n>Runnable</span><span class=o>,</span> <span class=n>Delayed</span> <span class=o>{</span>
        <span class=kd>protected</span> <span class=kd>static</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DelayedTask</span><span class=o>&gt;</span> <span class=n>sequence</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
        <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>counter</span><span class=o>++;</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>delta</span><span class=o>;</span>
        <span class=cm>/** 到期时间 */</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>trigger</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>DelayedTask</span><span class=o>(</span><span class=kt>int</span> <span class=n>delayInMilliseconds</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>delta</span> <span class=o>=</span> <span class=n>delayInMilliseconds</span><span class=o>;</span>
            <span class=n>trigger</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>()</span> <span class=o>+</span> <span class=n>NANOSECONDS</span><span class=o>.</span><span class=na>convert</span><span class=o>(</span><span class=n>delta</span><span class=o>,</span> <span class=n>MILLISECONDS</span><span class=o>);</span>
            <span class=n>sequence</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=nf>getDelay</span><span class=o>(</span><span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>unit</span><span class=o>.</span><span class=na>convert</span><span class=o>(</span><span class=n>trigger</span> <span class=o>-</span> <span class=n>System</span><span class=o>.</span><span class=na>nanoTime</span><span class=o>(),</span> <span class=n>NANOSECONDS</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>int</span> <span class=nf>compareTo</span><span class=o>(</span><span class=n>Delayed</span> <span class=n>arg</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>DelayedTask</span> <span class=n>that</span> <span class=o>=</span> <span class=o>(</span><span class=n>DelayedTask</span><span class=o>)</span> <span class=n>arg</span><span class=o>;</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>trigger</span> <span class=o>&lt;</span> <span class=n>that</span><span class=o>.</span><span class=na>trigger</span><span class=o>)</span> <span class=k>return</span> <span class=o>-</span><span class=n>1</span><span class=o>;</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>trigger</span> <span class=o>&gt;</span> <span class=n>that</span><span class=o>.</span><span class=na>trigger</span><span class=o>)</span> <span class=k>return</span> <span class=n>1</span><span class=o>;</span>
            <span class=k>return</span> <span class=n>0</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34; &#34;</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>String</span> <span class=nf>toString</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;[%1$-4d]&#34;</span><span class=o>,</span> <span class=n>delta</span><span class=o>)</span> <span class=o>+</span> <span class=s>&#34; Task &#34;</span> <span class=o>+</span> <span class=n>id</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=kd>public</span> <span class=n>String</span> <span class=nf>summary</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;(&#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=n>delta</span> <span class=o>+</span> <span class=s>&#34;)&#34;</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=kd>static</span> <span class=kd>class</span> <span class=nc>EndSentinel</span> <span class=kd>extends</span> <span class=n>DelayedTask</span> <span class=o>{</span>
            <span class=kd>private</span> <span class=n>ExecutorService</span> <span class=n>exec</span><span class=o>;</span>

            <span class=kd>public</span> <span class=nf>EndSentinel</span><span class=o>(</span><span class=kt>int</span> <span class=n>delay</span><span class=o>,</span> <span class=n>ExecutorService</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=kd>super</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
                <span class=n>exec</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>
            <span class=o>}</span>

            <span class=nd>@Override</span>
            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
                <span class=k>for</span> <span class=o>(</span><span class=n>DelayedTask</span> <span class=n>pt</span> <span class=o>:</span> <span class=n>sequence</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>print</span><span class=o>(</span><span class=n>pt</span><span class=o>.</span><span class=na>summary</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; &#34;</span><span class=o>);</span>
                <span class=o>}</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>();</span>
                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>this</span> <span class=o>+</span> <span class=s>&#34; Calling shutdownNow()&#34;</span><span class=o>);</span>
                <span class=n>exec</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DelayedTaskConsumer</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=o>{</span>
        <span class=kd>private</span> <span class=n>DelayQueue</span><span class=o>&lt;</span><span class=n>DelayedTask</span><span class=o>&gt;</span> <span class=n>q</span><span class=o>;</span>

        <span class=kd>public</span> <span class=nf>DelayedTaskConsumer</span><span class=o>(</span><span class=n>DelayQueue</span><span class=o>&lt;</span><span class=n>DelayedTask</span><span class=o>&gt;</span> <span class=n>q</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>this</span><span class=o>.</span><span class=na>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>;</span>
        <span class=o>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
            <span class=k>try</span> <span class=o>{</span>
                <span class=k>while</span> <span class=o>(!</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span>
                    <span class=c1>// Run task with the current thread
</span><span class=c1></span>                    <span class=n>q</span><span class=o>.</span><span class=na>take</span><span class=o>().</span><span class=na>run</span><span class=o>();</span>
            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                <span class=c1>// Acceptable way to exit
</span><span class=c1></span>            <span class=o>}</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Finished DelayedTaskConsumer&#34;</span><span class=o>);</span>
        <span class=o>}</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=n>47</span><span class=o>);</span>
        <span class=n>ExecutorService</span> <span class=n>exec</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newCachedThreadPool</span><span class=o>();</span>
        <span class=n>DelayQueue</span><span class=o>&lt;</span><span class=n>DelayedTask</span><span class=o>&gt;</span> <span class=n>queue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DelayQueue</span><span class=o>&lt;&gt;();</span>
        <span class=c1>// Fill with tasks that have random delays:
</span><span class=c1></span>        <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>20</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span>
            <span class=n>queue</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=k>new</span> <span class=n>DelayedTask</span><span class=o>(</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>5000</span><span class=o>)));</span>
        <span class=c1>// Set the stopping point
</span><span class=c1></span>        <span class=n>queue</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>DelayedTask</span><span class=o>.</span><span class=na>EndSentinel</span><span class=o>(</span><span class=n>5000</span><span class=o>,</span> <span class=n>exec</span><span class=o>));</span>
        <span class=n>exec</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=k>new</span> <span class=n>DelayedTaskConsumer</span><span class=o>(</span><span class=n>queue</span><span class=o>));</span>
    <span class=o>}</span>
<span class=o>}</span>
<span class=cm>/* output（sample）
</span><span class=cm>[128 ] Task 11 [200 ] Task 7 [429 ] Task 5 [520 ] Task 18 [555 ] Task 1 [961 ] Task 4 [998 ] Task 16 [1207] Task 9 [1693] Task 2 [1809] Task 14 [1861] Task 3 [2278] Task 15 [3288] Task 10 [3551] Task 12 [4258] Task 0 [4258] Task 19 [4522] Task 8 [4589] Task 13 [4861] Task 17 [4868] Task 6
</span><span class=cm>(0:4258) (1:555) (2:1693) (3:1861) (4:961) (5:429) (6:4868) (7:200) (8:4522) (9:1207) (10:3288) (11:128) (12:3551) (13:4589) (14:1809) (15:2278) (16:998) (17:4861) (18:520) (19:4258) (20:5000)
</span><span class=cm>[5000] Task 20 Calling shutdownNow()
</span><span class=cm>Finished DelayedTaskConsumer
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>从输出可以看到，任务入队的顺序和任务出队的顺序没有任何关系，任务是按照超时先后出队的。</p>
<div class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>这个示例演化自<a href=https://book.douban.com/subject/26591326/>《Java并发编程的艺术》方腾飞等.著</a>，第八章8.2节代码清单8-4。不过该书中关于这段代码的运行解释是不正确的，本例也证明了这一点。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:2 role=doc-endnote>
<p>《Thinking in Java》 4th Edition, 第21章21.7.2示例代码。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:3 role=doc-endnote>
<p>就算有任务再次进入了reset流程，也依然可能存在上面描述的问题，这仅仅增加了程序运行的不稳定性。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:4 role=doc-endnote>
<p>并不能保证先调用<code>acquire()</code>方法的线程就能先获得许可，而是先调用方法的线程先执行内部逻辑的线程优先获取许可。所以有可能线程a先于线程b调用<code>acquire()</code>方法，但是却晚于线程b到达“等待点”。&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:5 role=doc-endnote>
<p>这个示例演化自Semaphore的javaDoc：https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Semaphore.html。&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:6 role=doc-endnote>
<p>如果使用是个“许可证数”为1的Semaphore，其作用相当于一个独占锁，任意时刻只有一个任务能够获取许可并且对资源进行修改，此时，<code>getItem</code>方法可以不使用同步。&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:7 role=doc-endnote>
<p>这个示例演化自Exchanger的javaDoc：https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Exchanger.html。&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:8 role=doc-endnote>
<p>忽略类型检查的原因是因为尚不能处理泛型编程的所有问题。理论上这里传入任意Queue<t>实现类都是可以的，但是由于示例中所用的实例Fat并没有实现Comparable接口，所以当传入优先级队列时，构造器会抛出初始化异常。&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:9 role=doc-endnote>
<p>这里还存在一个潜在问题：<code>EmptyTask</code>完成时取消<code>FillTask</code>，<code>FillTask</code>的状态会影响程序的结果，若后者是在Exchanger处被阻塞时取消，那将抛出中断异常，程序输出如示例中说的那样；若后者在向缓存中添加对象时被中断，<code>shutdown()</code>方法无法立刻中止<code>FillTask</code>的运行，它将继续运行至进入栅栏而抛出异常，但是，主线程中的遍历(在使用普通队列时)就可能会抛出ConcorrentModificationException。解决此问题的方法是在<code>FillTask</code>中分别处理2种取消的情况，或者在主线程中使用<code>awaitTermination</code>等待<code>FillTask</code>抛出异常而终结。&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
<li id=fn:10 role=doc-endnote>
<p>Delay接口实际上继承了Comparable接口。&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</div>
</article>
<script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script>'use strict';document.addEventListener('DOMContentLoaded',function(){var a=!1,b=document.querySelectorAll('pre.chroma'),c=document.querySelectorAll('.language-code'),d=document.querySelectorAll('div.language-\\$'),e=document.querySelectorAll('div.language-\\>'),f=function(c){var k=c,b=c.textContent,j,g,h,i,d,f,e;if(b.length>15){a||(j=new ClipboardJS('.copy-to-clipboard',{text:function(a){var c=prev(a).querySelectorAll('code');return c.length>1?b=prev(a).querySelector('code[class^="language-"]').textContent:b=prev(a).querySelector('code').textContent,b.replace(/^\$\s/gm,'')}}),j.on('success',function(a){a.clearSelection(),g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label','Copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),j.on('error',function(a){g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label',a.action.toString()),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),a=!0),h=['language-mermaid','language-viz','language-wave','language-chart','language-msc','language-flowchart'],i=!1,d=k.getAttribute('class');for(f=0;f<h.length;f++)if(d&&d.startsWith(h[f])){i=!0;break}i||d&&(e=document.createElement('span'),e.setAttribute('class','copy-to-clipboard'),e.setAttribute('title','Copy to clipboard'),c.parentNode.parentNode.insertBefore(e,c.parentNode.nextElementSibling))}},g=function(b){var a=document.createElement('span');a.setAttribute('class','copy-to-clipboard'),a.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(a,b.parentNode.nextElementSibling)};b?b.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,c?c.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,d?d.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null,e?e.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null})</script>
<script>'use strict';var langCodeElem,dollarCodeElem,gtCodeElem;function wrap(a,b){a.parentNode.insertBefore(b,a),b.appendChild(a)}(function(){var a=document.querySelector('.single__contents');a?a.querySelectorAll('pre > code').forEach(function(b){var a=b.getAttribute('data-lang'),c=document.createElement('div'),e=null,d=null;a&&a.includes(':')?(e=a.split(':')[0],d=a.split(':')[1],c.className='language-'+e,c.setAttribute('data-lang',d),b.className='language-'+e,b.setAttribute('data-lang',d),b.setAttribute('id',d)):a||(c.setAttribute('data-lang','Code'),c.className='language-code'),(!a||d)&&wrap(b.parentNode,c)}):null})(),langCodeElem=document.querySelectorAll('.language-code'),langCodeElem?langCodeElem.forEach(function(b){var a=document.createElement('span');a.className='copy-to-clipboard',a.setAttribute('title','Copy to clipboard'),b.append(a)}):null,dollarCodeElem=document.querySelectorAll('div.language-\\$'),gtCodeElem=document.querySelectorAll('div.language-\\>'),dollarCodeElem?dollarCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='$<br/>'}):null}):null,gtCodeElem?gtCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='><br/>'}):null}):null</script>
<div class=whoami__gutter></div>
<hr class="hr-slash whoami-hr">
<section class=whoami>
<div class=whoami__image-wrapper>
<img data-src=/images/whoami/avatar.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=wangy325 class="lazyload whoami__image">
</div>
<div class=whoami__contents>
<div class=whoami__written-by>
作者
</div>
<div class=whoami__title>
wangy325
</div>
<div class=whoami__desc>
Web Developer
</div>
<div class=whoami__social>
<a href=mailto:wangy325@qq.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg>
</a>
<a href=https://github.com/wangy325/endlessriver title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg>
</a>
</div>
</div>
</section>
<hr class="hr-slash whoami-hr">
<section class=related>
</section>
<div class=grow></div>
<nav class=pagination-single>
<a href=https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/ class=pagination-single__left>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg>
</div>
<div class=pagination-single__left-title>Java并发系列之8——计划执行任务</div>
</a>
<div class=grow></div>
<a href=https://wangy325.github.io/zh/posts/java/redis/bloom-filter/ class=pagination-single__right>
<div class=pagination-single__right-title>布隆过滤器(转)</div>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg>
</div>
</a>
</nav>
<div class="modal micromodal-slide" id=modal aria-hidden=true>
<div class=modal__overlay tabindex=-1 data-micromodal-close>
<div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title>
<div class=modal__content id=modal-content>
<div id=mySwipe class=swipe>
<div class=swipe-wrap>
</div>
</div>
</div>
<span class=modal__items>
<span class=modal__header>
<div class=modal__paging title="Page Info" aria-label="Current Page">
</div>
<div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg>
</div>
</span>
<div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg>
</div>
<div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg>
</div>
<div class=modal__caption>
<div class=modal__caption--text>
</div>
</div>
</span>
</div>
</div>
</div>
<script defer src=/js/swipe.min.989e074dfb92ce7f57a92c1df7027f88b53c50a54fd9ad450a673a64aa91bfa4.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener('DOMContentLoaded',function(){var d=document.documentElement,g,f,s,r,m,o,l,b,c,i,n,e,h,j,a,p,q;function t(){d.requestFullscreen?d.requestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&d.msRequestFullscreen()}function k(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}g=document.getElementById('modal'),f=document.querySelector('.gallery__container'),s=document.querySelector('.swipe-wrap'),r=document.getElementById('mySwipe'),m=document.querySelector('.modal__arrow--left'),o=document.querySelector('.modal__arrow--right'),l=document.querySelector('.modal__toolbar--close'),b=document.querySelector('.modal__toolbar--full'),c=document.querySelector('.modal__toolbar--normal'),i=document.querySelector('.modal__caption'),n=document.querySelector('.modal__paging'),e=document.querySelector('.modal__items'),h=null,j=null,a=null,p=function(b){b.key==='ArrowRight'?g&&g.classList.contains('is-open')&&a.next():b.key==='ArrowLeft'&&g&&g.classList.contains('is-open')&&a.prev()},f?h=f.querySelectorAll('img').length:(f=document.querySelector('.single__contents'),h=f.querySelectorAll('img').length),MicroModal.init({onClose:function(){a&&(a.kill(),a=null,k()),window.removeEventListener('keydown',p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),q=function(a){return new Promise(function(c,d){var b=new Image;b.onload=function(){c(b)},b.onerror=d,b.src=a})},f.querySelectorAll('img').forEach(function(g,k){var f,d;g.style.cursor='pointer',f=g.cloneNode(!0),f.style.maxHeight='100%',f.style.maxWidth='100%',f.onclick=function(a){a.stopPropagation()},d=document.createElement('div'),d.style.width='100%',d.style.height='100vh',d.setAttribute('data-micromodal-close',''),d.onclick=function(){a&&(a.kill(),a=null)},d.onmouseenter=function(){clearTimeout(j),fadeIn(e,200)},d.onmouseleave=function(){j=setTimeout(function(){fadeOut(e,200)},2500)},d.ontouchstart=function(){fadeIn(e,200)},d.append(f),s.append(d),g.addEventListener('click',async function(d){var m,l,g;MicroModal.show('modal'),a&&(a.kill(),a=null),m=d.target.getAttribute('data-src')||d.target.getAttribute('src'),l=await q(m),f.style.width=l.width+'px',f.style.height=l.height+'px',a=new Swipe(r,{startSlide:k,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(d,f){var a=f.querySelector('img'),g=a.getAttribute('data-src')||a.getAttribute('src'),c=await q(g),b;a.style.width=c.width+'px',a.style.height=c.height+'px',i&&a&&(b=null,a.getAttribute('data-caption')?b=a.getAttribute('data-caption'):a.getAttribute('title')?b=a.getAttribute('title'):a.getAttribute('alt')?b=a.getAttribute('alt'):b=a.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=b,n.innerText=d+1+' / '+h,clearTimeout(j),fadeIn(e,200))}}),fadeIn(e),i&&(g=null,d.target.getAttribute('data-caption')?g=d.target.getAttribute('data-caption'):d.target.getAttribute('title')?g=d.target.getAttribute('title'):d.target.getAttribute('alt')?g=d.target.getAttribute('alt'):g=d.target.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=g,n.innerText=k+1+' / '+h),c&&b&&(c.style.zIndex=-1,c.style.opacity=0,b.style.zIndex=25,b.style.opacity=1)}),window.addEventListener('keydown',p)}),m?m.addEventListener('click',function(b){a&&a.prev()}):null,o?o.addEventListener('click',function(b){a&&a.next()}):null,l?l.addEventListener('click',function(){a&&(a.kill(),a=null),k(),MicroModal.close('modal')}):null,b?b.addEventListener('click',function(a){t(),c&&(c.style.zIndex=25,c.style.opacity=1,b.style.zIndex=-1,b.style.opacity=0)}):null,c?c.addEventListener('click',function(a){k(),b&&(b.style.zIndex=25,b.style.opacity=1,c.style.zIndex=-1,c.style.opacity=0)}):null})</script>
<div class=hide>
<div class=search>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</span>
<input id=search aria-label="Site Search" class=input type=text placeholder=搜索 autocomplete=off>
<div id=search-results class=dropdown>
<div id=search-menu class=dropdown-menu role=menu>
</div>
</div>
</div>
</div>
</div>
</main>
<script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"outer"'),singleMainElem=document.querySelector('.single__main'),singleSideElem=document.querySelector('.single__side');enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main'),singleSideElem.classList.remove('main-side'),singleSideElem.classList.add('hide')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide'))},unmatch:function(){var b,a;(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove('main'),singleMainElem.classList.add('main-main'),singleSideElem.classList.remove('hide'),singleSideElem.classList.add('main-side')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide')),b=document.querySelector('.navbar__burger'),a=document.getElementsByClassName('navbarm__collapse')[0],a&&(a.setAttribute('data-open',!1),a.style.maxHeight=0,b.classList.remove('is-active')),document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active'),document.getElementsByClassName('mobile-search')[0].classList.add('hide')},setup:function(){},deferSetup:!0,destroy:function(){}})</script>
<script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script defer src=/js/helper/throttle.min.js></script>
<script>'use strict';window.onload=function(){var f=document.querySelector('.navbar'),D=document.querySelector('.single__contents'),E=JSON.parse("true"),J=JSON.parse("true"),s,H,F,L,k,j,A,g,u,x,d,e,l,i,I,C,K,v,N,y,r,z,b,w,t,M,h,c,G,a,m,n,o,p,B,q;E&&J&&(s=document.querySelector('#busuanzi_value_page_pv'),s.textContent=s.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),H=JSON.parse("true"),F=JSON.parse("null"),L=JSON.parse("false"),k=document.querySelector('.toc__flexbox'),j=document.querySelector('.toc__flexbox--outer'),A=JSON.parse("false"),(H||F)&&document.querySelector('.toc')&&(g=document.querySelector('.toc').querySelector('#TableOfContents'),g.onmouseenter=function(){f.classList.contains('scrolling')&&f.classList.remove('scrolling')},g.onmouseleave=function(){f.classList.contains('scrolling')||f.classList.add('scrolling')},!1===A||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),g&&(g.querySelectorAll('a').length>0?g.querySelectorAll('a').forEach(function(a){a.addEventListener('click',function(){var c=a.getAttribute('id'),b;f.classList.contains('scrolling')||(f.classList.remove('navbar--show'),f.classList.remove('navbar--hide'),f.classList.add('navbar--hide')),document.querySelector('.toc').querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),a.classList.add('active'),b=g.querySelector('[href="#'+c+'"]'),b&&b.nextElementSibling&&(b.nextElementSibling.style.display='block'),b&&(getParents(b,'ul')?getParents(b,'ul').forEach(function(a){a.style.display='block'}):null)})}):(k&&(k.setAttribute('data-position',''),k.classList.contains('hide')||k.classList.add('hide')),j&&(j.setAttribute('data-position',''),j.classList.contains('hide')||j.classList.add('hide')))),u=document.getElementById("toggle-toc"),x=document.getElementById('visible-toc'),d=document.querySelector('.toc'),e=document.querySelector('main'),l=document.querySelector('side'),i=document.querySelector('.toc__flexbox'),u?u.addEventListener('change',function(a){a.target.checked?(d&&fadeIn(d,200),i&&i.setAttribute('data-position','fixed'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main-main')),l&&l.classList.remove('main-side')):(d&&fadeOut(d,200),i&&i.setAttribute('data-position','absolute'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main')),l&&l.classList.remove('main-side'))}):null,x?x.addEventListener('change',function(a){a.target.checked?d&&fadeIn(d,200):d&&fadeOut(d,200)}):null),I=120,C=70,K=function(){d&&(d.style.maxHeight=window.innerHeight-I-C+'px')},v=throttle(K,300),v(),window.addEventListener('resize',v),y=new ClipboardJS('.anchor'),r=D.querySelectorAll("h1, h2, h3, h4"),z=JSON.parse('"ltr"'),r?r.forEach(function(c){var d=parseInt(c.tagName.substr(1),10)*2,e=encodeURI(document.location.origin+document.location.pathname),f=e+"#"+c.getAttribute('id'),b=document.createElement('span'),a;b.classList.add('anchor'),b.classList.add('hide'),b.setAttribute('data-clipboard-text',decodeURI(f)),b.style.position='relative',a=document.createElement('span'),a.style.position='absolute',a.style.top='50%',a.style.left='0.75rem',a.style.transform='translateY(-50%)',a.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-d}px" height="${32-d}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,z==="rtl"?a.style.left='-2rem':a.style.right='-2rem',b.append(a),c.append(b),c.addEventListener('mouseenter',function(){this.querySelector('.anchor').classList.remove('hide')}),c.addEventListener('mouseleave',function(){this.querySelector('.anchor').classList.add('hide')})}):null,document.querySelectorAll('.anchor').forEach(function(a){a.addEventListener('mouseleave',function(){a.setAttribute('aria-label',null),a.classList.remove('tooltipped'),a.classList.remove('tooltipped-s'),a.classList.remove('tooltipped-w')})}),y.on('success',function(a){a.clearSelection(),a.trigger.setAttribute('aria-label','Link copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-s')}),b=JSON.parse("null"),b&&b.includes('mermaid')&&(w=localStorage.getItem('theme')||JSON.parse('"light"'),w==="dark"||w==="hacker"?mermaid.initialize({theme:'dark'}):mermaid.initialize({theme:'default'}),t=[],[].push.apply(t,document.getElementsByClassName('language-mermaid')),t.forEach(function(b){var a=b.parentNode,c;a!==document.body&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)),c=document.createElement('div'),c.classList.add('mermaid'),c.style.padding='34px 4px 6px',c.innerHTML=b.innerHTML,b.replaceWith(c)})),b&&b.includes('katex')&&(M=document.getElementsByClassName('math'),h={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector('.single__contents'),h)),b&&b.includes('flowchartjs')&&(h=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),c=null,G="language-flowchart",a=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+G+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='flowchart'+a,b.parentNode.insertBefore(d,b),e=flowchart.parse(c),e.drawSVG("flowchart"+a,h),a+=1})),document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'}),b&&b.includes('msc')&&(h=JSON.parse('{"theme":"hand"}'),c=null,a=0,m="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='msc'+a,b.parentNode.insertBefore(d,b),e=Diagram.parse(c),e.drawSVG("msc"+a,h),a+=1})),b&&b.includes('chart')&&(n="#666",o="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=n,Chart.defaults.global.elements.rectangle.backgroundColor=o,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=n,Chart.defaults.global.elements.line.backgroundColor=o,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=n,Chart.defaults.global.elements.point.backgroundColor=o,m="language-chart",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e,f,g;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('canvas'),e=null,d.height=200,d.style.height=200,d.id='myChart'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),f=document.getElementById('myChart'+a).getContext('2d'),g=new Chart(f,e),a+=1})),b&&b.includes('wavedrom')&&(B="language-wave",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+B+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),e=null,d.id='WaveDrom_Display_'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),WaveDrom.RenderWaveForm(a,e,"WaveDrom_Display_"),a+=1})),b&&b.includes('viz')&&(q="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+q+"]"),function(a){var b,c;a.style.display='none',a.parentNode.style.backgroundColor="transparent",a.getAttribute("class").split(" ").forEach(function(a){a.startsWith(q)&&(b=a.substr(q.length))}),c=new Viz,c.renderSVGElement(a.innerText,{engine:b}).then(function(b){b.style.width="100%",a.parentNode.insertBefore(b,a)})}))}</script>
<footer class=footer>
<div class=dropdown>
<button class=dropdown-trigger aria-label="Select Language Button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03c1.74-1.94 2.98-4.17 3.71-6.53h1.94c.54.0.99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54.0-.99.45-.99.99.0.55.45.99.99.99h10.18C11.5 7.92 10.44 9.75 9 11.35c-.81-.89-1.49-1.86-2.06-2.88-.16-.29-.45-.47-.78-.47-.69.0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87c-.4.39-.4 1.03.0 1.42.39.39 1.02.39 1.42.0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35zM17.5 10c-.6.0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39.0.74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65.0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94zm-1.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
</button>
<div class=dropdown-content>
<a href=https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/ data-lang=zh class="dropdown-item is-active">简体中文</a>
</div>
</div>
<div class=footer__social>
<div class=social>
<a href=mailto:wangy325@qq.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg>
</a>
<a href=https://github.com/wangy325/endlessriver title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg>
</a>
<a href=https://wangy325.github.io/zh/posts/index.xml type=application/rss+xml title=RSS aria-label="RSS Feed Link"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentcolor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentcolor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4.0.71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85.0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84.0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg>
</a>
</div>
</div>
<div id=gtt>
<div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg>
</div>
</div>
<hr>
<div class="basicflex flexwrap">
</div>
<div class=footer__poweredby>
<div class=busuanzi>
<div class=busuanzi__item>
<span class=busuanzi__item--label>
总访客
</span>
<span id=busuanzi_value_site_uv class=busuanzi__item--number>...</span>
</div>
<div class=busuanzi__item>
<span class=busuanzi__item--label>
总浏览
</span>
<span id=busuanzi_value_site_pv class=busuanzi__item--number>...</span>
</div>
</div>
<p class=caption>
©2019-2022, All Rights Reserved<a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/> CC BY-SA</a>
</p>
<p class=caption>Powered by <a href=https://gohugo.io/ target=_blank rel=noreferrer>Hugo</a> and the <a href=https://github.com/zzossig/hugo-theme-zzo target=_blank rel=noreferrer>Zzo theme</a></p>
</div>
</footer>
</div>
<div class="wrapper__right hide" data-pad=true dir=ltr>
<script>document.querySelector('.wrapper__right').classList.remove('hide')</script>
<div class=toc__flexbox--outer data-position=fixed data-dir=ltr data-ani=true>
<h6 class="toc__title toc__title--outer" data-ani=true>目录</h6>
</div>
<div class="toc toc__outer" data-dir=ltr data-folding=false data-ani=true>
<nav id=TableOfContents>
<ul>
<li><a href=#1-countdownlatch>1 CountDownLatch</a></li>
<li><a href=#2-cyclicbarrier>2 CyclicBarrier</a></li>
<li><a href=#3-semaphore>3 Semaphore</a></li>
<li><a href=#4-exchanger>4 Exchanger</a></li>
<li><a href=#5-priorityblockingqueue>5 PriorityBlockingQueue</a></li>
<li><a href=#6-delayqueue>6 DelayQueue</a></li>
</ul>
</nav>
</div>
</div>
</div>
</body>
</html>