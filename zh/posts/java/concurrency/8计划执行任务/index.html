<!doctype html><html lang=zh dir=ltr>
<head prefix="og: http://ogp.me/ns#">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Java并发系列之8——计划执行任务 – EndlessRiver</title>
<script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script>
<script defer src=/js/helper/getParents.min.ccd45f158c1b17849307ba913a72beac239c410f2b6e648496a79842da84e55b.js></script>
<script defer src=/js/helper/fadeinout.min.1d13d3e810c3940e80cbba6216a1c76fbf42b5431fc83537ea6997863802362b.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(b,a){'use strict';if(b instanceof RegExp)throw TypeError('first argument must not be a RegExp');return a===void 0&&(a=0),this.indexOf(b,a)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(a){if(!a.length)throw new Error('DOM Exception 8');if(a.length===1)return typeof a[0]=='string'?document.createTextNode(a[0]):a[0];for(var c=document.createDocumentFragment(),e=a.length,d=-1,b;++d<e;)b=a[d],c.appendChild(typeof b=='string'?document.createTextNode(b):b);return c}String.prototype.startsWith||(String.prototype.startsWith=function(b,a){return a=a||0,this.indexOf(b,a)===a}),document.addEventListener('DOMContentLoaded',function(){var A=document.querySelector('.navbar__burger'),V,F,G,Q,P,f,e,O,t,ag,K,I,o,g,z,l,b,r,s,W,H,d,E,h,B,C,ap,y,ao,an,am,al,ak,D,ac,aj,ah,ae,j,i,c,ad,w,Z,U,ab,x,p,R,m,ar,aq,a,at,L,n,J,S,T,u,q,v;A?A.addEventListener('click',function(c){var a=document.querySelector('.navbarm__collapse'),b;a&&(b=a.getAttribute('data-open'),b==='true'?(a.setAttribute('data-open','false'),a.style.maxHeight=0,A.classList.remove('is-active')):(a.setAttribute('data-open','true'),a.style.maxHeight=a.scrollHeight+"px",A.classList.add('is-active')))}):null,V=document.querySelectorAll('.single__contents > table');for(let a=0;a<V.length;a++)F=V[a],G=document.createElement('div'),G.className='table-wrapper',F.parentElement.replaceChild(G,F),G.appendChild(F);Q=document.querySelectorAll('.footnote-ref'),P=document.querySelectorAll('.footnote-backref'),Q?Q.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,P?P.forEach(function(a,c){a.onmouseenter=function(){b.classList.contains('scrolling')&&b.classList.remove('scrolling')},a.onmouseleave=function(){b.classList.contains('scrolling')||setTimeout(function(){b.classList.add('scrolling')},100)},a.onclick=function(){b.classList.contains('scrolling')||(b.classList.remove('navbar--show'),b.classList.remove('navbar--hide'),b.classList.add('navbar--hide'))}}):null,f=document.querySelector('.summary__container'),e=document.querySelector('.search-result'),O=document.querySelector('.search-result__close'),O?O.addEventListener('click',function(a){e.setAttribute('data-display','none'),f.setAttribute('data-display','block')}):null,document.querySelectorAll('.tab')?document.querySelectorAll('.tab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.tab__link'),c=a.querySelectorAll('.tab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,document.querySelectorAll('.codetab')?document.querySelectorAll('.codetab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.codetab__link'),c=a.querySelectorAll('.codetab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,t=document.getElementById("gtt"),t.style.display="none",t.addEventListener('click',function(){window.document.documentMode?document.documentElement.scrollTop=0:af(250)});function af(a){var b=-window.scrollY/(a/15),c=setInterval(function(){window.scrollY!=0?window.scrollBy(0,b):clearInterval(c)},15)}ag=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?t.style.display="block":t.style.display="none"},K=document.querySelectorAll('.expand__button');for(let a=0;a<K.length;a++)K[a].addEventListener("click",function(){var a=this.nextElementSibling;a.style.maxHeight?(a.style.maxHeight=null,this.querySelector('svg').classList.add('expand-icon__right'),this.querySelector('svg').classList.remove('expand-icon__down')):(a.style.maxHeight=a.scrollHeight+"px",this.querySelector('svg').classList.remove('expand-icon__right'),this.querySelector('svg').classList.add('expand-icon__down'))});I=window.pageYOffset||document.documentElement.scrollTop,o=document.querySelector('.toc'),g=o?o.querySelector('#TableOfContents'):null,z=document.getElementById('toggle-toc'),l=document.querySelector('.single__contents'),b=document.querySelector('.navbar'),r=document.querySelector('.toc__flexbox'),s=document.querySelector('.toc__flexbox--outer'),W=document.querySelectorAll('.expand__content'),H=document.querySelectorAll('.box'),d=null,E=JSON.parse("false"),h=JSON.parse('["h2","h3","h4"]'),h?h=h.toString():h="h1, h2, h3, h4, h5, h6",l&&l.querySelectorAll(".tab")?l.querySelectorAll(".tab").forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,W?W.forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,H?H.forEach(function(a){a.querySelectorAll(h).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,window.onscroll=function(){ag();var a=window.pageYOffset||document.documentElement.scrollTop;if(a>I){if(a<250?t.style.display="none":t.style.display="block",a<45)return null;b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.contains('navbar--show')&&b.classList.remove('navbar--show'):b.classList.add('navbar--hide')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(z&&!z.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===E||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&(r.setAttribute('data-position',''),r.classList.contains('hide')||r.classList.add('hide')),s&&(s.setAttribute('data-position',''),s.classList.contains('hide')||s.classList.add('hide'))))}else a<250&&(t.style.display="none"),b.classList.contains('scrolling')&&(b.classList.contains('navbar--hide')?b.classList.remove('navbar--hide'):b.classList.contains('navbar--show')||b.classList.add('navbar--show')),l&&(l.querySelectorAll(h).length>0?l.querySelectorAll(h).forEach(function(c){var b,a;if(z&&!z.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),o.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),o.querySelector('a[href="#'+b+'"]')?o.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===E||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&!r.classList.contains('hide')&&r.classList.add('hide'),s&&!s.classList.contains('hide')&&s.classList.add('hide'))),g&&document.documentElement.scrollTop<250&&(!1===E||(g.querySelector('ul')?g.querySelector('ul').querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})}):null));I=a<=0?0:a},B=localStorage.getItem('theme'),C=document.getElementById('root'),ap=document.querySelectorAll('.select-theme'),y=document.querySelectorAll('.select-theme__item'),ao=JSON.parse('"dark"'),an=JSON.parse('"light"'),am=JSON.parse('"hacker"'),al=JSON.parse('"solarized"'),ak=JSON.parse('"kimbie"'),D=function(a){var b=document.getElementsByName('msapplication-TileColor')[0],c=document.getElementsByName('theme-color')[0],d=document.getElementsByName('msapplication-navbutton-color')[0],e=document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];a.includes('dark')?(b.setAttribute('content','#fcfcfa'),c.setAttribute('content','#403E41'),d.setAttribute('content','#403E41'),e.setAttribute('content','#403E41')):a.includes('light')?(b.setAttribute('content','#555'),c.setAttribute('content','#eee'),d.setAttribute('content','#eee'),e.setAttribute('content','#eee')):a.includes('hacker')?(b.setAttribute('content','#e3cd26'),c.setAttribute('content','#252526'),d.setAttribute('content','#252526'),e.setAttribute('content','#252526')):a.includes('solarized')?(b.setAttribute('content','#d3af86'),c.setAttribute('content','#51412c'),d.setAttribute('content','#51412c'),e.setAttribute('content','#51412c')):a.includes('kimbie')&&(b.setAttribute('content','#586e75'),c.setAttribute('content','#eee8d5'),d.setAttribute('content','#eee8d5'),e.setAttribute('content','#eee8d5'))},ac=function(a){if(a===ao)return'dark';if(a===an)return'light';if(a===am)return'hacker';if(a===al)return'solarized';if(a===ak)return'kimbie'},B?(y?y.forEach(function(a){a.text.trim()===B?a.classList.add('is-active'):a.classList.remove('is-active')}):null,D(B)):D(C.className),y?y.forEach(function(a,b){a.addEventListener('click',function(c){var a=ac(c.target.text.trim()),b,d;localStorage.setItem('theme',a),D(a),C.removeAttribute('class'),C.classList.add('theme__'+a),ap.forEach(function(b){b.querySelectorAll('a').forEach(function(b){b.classList&&(b.text.trim()===a?b.classList.contains('is-active')||b.classList.add('is-active'):b.classList.contains('is-active')&&b.classList.remove('is-active'))})}),window.mermaid&&(a==="dark"||a==="hacker"?(mermaid.initialize({theme:'dark'}),location.reload()):(mermaid.initialize({theme:'default'}),location.reload())),b=document.getElementById('utterances'),b&&b.querySelector('iframe').contentWindow.postMessage({type:'set-theme',theme:a==="dark"||a==="hacker"?'photon-dark':a==='kimbie'?'github-dark-orange':'github-light'},'https://utteranc.es'),d=document.querySelectorAll('.twitter-timeline'),d&&window.postMessage({type:'set-twitter-theme',theme:a==='light'||a==='solarized'?'light':'dark'})})}):null,aj=JSON.parse('"https://wangy325.github.io"'),ah=JSON.parse('"https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/"'),ae=JSON.parse('"/zh"'),j=null,i=null,c=null,ad=JSON.parse("true"),w=JSON.parse("true"),Z=JSON.parse('"main"'),U=JSON.parse('"posts"'),ab=JSON.parse('"page"'),x=null,ad&&function(){var a=new XMLHttpRequest;U==="publication"&&ab!=="page"?a.open('GET',ah+"index.json"):a.open('GET',aj+ae+"/index.json"),a.setRequestHeader('Content-Type','application/json; charset=utf-8'),a.onload=function(){a.status===200?(x=new Fuse(JSON.parse(a.response.toString('utf-8')),{keys:U.includes('publication')?['title','abstract']:['title','description','content'],includeMatches:w,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=x):console.error('['+a.status+']Error:',a.statusText)},a.send()}();function ai(e,a){var b=document.createElement('li'),c,d;b.className='search-result__item',c=document.createElement('a'),c.innerHTML=a.item.title,c.setAttribute('class','search-result__item--title'),c.setAttribute('href',a.item.permalink),d=document.createElement('div'),d.setAttribute('class','search-result__item--desc'),a.item.description?d.innerHTML=a.item.description:a.item.content&&(d.innerHTML=a.item.content.substring(0,225)),b.appendChild(c),b.appendChild(d),e.appendChild(b)}function $(f,a){var e=document.createElement('li'),b,d,c;if(e.className='search-result__item',b=null,d=document.createElement('a'),d.innerHTML=a.item.title,d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri),a.matches&&a.matches.length){for(c=0;c<a.matches.length;c++)'title'===a.matches[c].key&&(d=document.createElement('a'),d.innerHTML=k(a.matches[c].value,a.matches[c].indices),d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri)),'description'===a.matches[c].key?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.description,a.matches[c].indices)):'content'===a.matches[c].key?b||(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=k(a.item.content.substring(0,150),a.matches[c].indices)):a.item.description?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.description):(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.content.substring(0,150));e.appendChild(d),b&&e.appendChild(b),e&&f.appendChild(e)}}function Y(d,c){var a,b;for(j=document.getElementById('search-results'),i=document.getElementById('search-menu'),j.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var e=document.createElement('li'),c=document.createElement('a'),f,d;c.setAttribute('href',b.uri),c.setAttribute('class','dropdown-item'),c.appendChild(e),f=document.createElement('div'),f.innerHTML=b.title,f.setAttribute('class','menu-item__title'),d=document.createElement('div'),d.setAttribute('class','menu-item__desc'),b.description?d.innerHTML=b.description:b.content&&(d.innerHTML=b.content.substring(0,150)),e.appendChild(f),e.appendChild(d),a.appendChild(c)}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function M(d,c){var a,b;for(j=document.getElementById('search-results'),i=document.getElementById('search-menu'),j.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var g=document.createElement('li'),e=document.createElement('a'),c=null,f,d;if(e.setAttribute('href',b.item.uri),e.setAttribute('class','dropdown-item'),e.appendChild(g),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','menu-item__title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.content.substring(0,150));g.appendChild(f),c&&g.appendChild(c),a.appendChild(e)}}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function X(e,c){var a,d;j=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length>0?c.forEach(function(b){var c=document.createElement('a');c.setAttribute('href',b.uri),c.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+b.title+'</div><div class="mobile-search__item--desc">'+(b.description?b.description:b.content)+'</div></div>',a.appendChild(c)}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);j.appendChild(a)}function aa(e,c){var a,d;j=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length?c.forEach(function(b){var e=document.createElement('li'),g=document.createElement('a'),c=null,f,d;if(g.setAttribute('href',b.item.uri),g.appendChild(e),e.setAttribute('class','mobile-search__item'),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','mobile-search__item--title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=k(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=k(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.content.substring(0,150));e.appendChild(f),c&&e.appendChild(c),a.appendChild(g)}}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);j.appendChild(a)}function k(a,d){if(!d)return a;var b='',c=0;return d.forEach(function(d){if(d[0]===d[1])return null;b+=''+a.substring(c,d[0])+'<span class="search__highlight">'+a.substring(d[0],d[1]+1)+'</span>'+'',c=d[1]+1}),b+=a.substring(c),b}p=document.getElementById('search'),R=document.getElementById('search-mobile'),m=document.getElementById('search-results'),p?p.addEventListener('input',function(b){var a,d;if(!b.target.value|window.innerWidth<770)return m?m.setAttribute('class','dropdown'):null,e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null,null;c=b.target.value,a=x.search(b.target.value),Z==="main"?w?_(c,a):N(c,a):(w?M(c,a):Y(c,a),d=m.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,p?p.addEventListener('blur',function(){if(window.innerWidth<770)return null;m?m.setAttribute('class','dropdown'):null}):null,p?p.addEventListener('click',function(b){var a,d;if(window.innerWidth<770)return null;if(!b.target.value)return m?m.setAttribute('class','dropdown'):null,null;c=b.target.value,a=x.search(b.target.value),Z==="main"?w?_(c,a):N(c,a):(w?M(c,a):Y(c,a),d=m.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,ar=document.getElementById("search-menu"),aq=document.querySelector('#search-menu .dropdown-item.is-active'),a=null,at=null,L=350,p?p.addEventListener('keydown',function(c){var b,d;if(window.innerWidth<770)return null;if(c.key==='Escape'&&(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b=document.querySelectorAll('#search-menu .dropdown-item'),d=c.which||c.keyCode,!b||!b.length)return null;if(c.key==='ArrowDown'||d===40){a===null?(a=0,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===b.length-1?0:a+1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-L;c>0?document.querySelector(".search-content").scrollTop+=b[a].getBoundingClientRect().height:a===0&&(document.querySelector(".search-content").scrollTop=0)}else if(c.key==='ArrowUp'||d===38){a===null?(a=b.length-1,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===0?b.length-1:a-1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-L;c<0?document.querySelector(".search-content").scrollTop-=b[a].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=c+b[a].getBoundingClientRect().height}else c.key==='Enter'||d===13?b[a]&&b[a].getAttribute('href')&&(location.href=b[a].getAttribute('href')):(c.key==='Escape'||d===27)&&(c.target.value=null,j&&j.classList.remove('is-active'))}):null,R?R.addEventListener('input',function(a){if(!a.target.value){let a=document.getElementById('search-mobile-results');while(a.firstChild)a.removeChild(a.firstChild);return null}c=a.target.value;var b=x.search(a.target.value);X(c,b),w?aa(c,b):X(c,b)}):null,n=document.querySelector('#search-mobile'),J=document.querySelector('.mobile-search'),S=document.querySelectorAll('.navbar-search'),T=document.querySelector('#search-mobile-close'),u=document.querySelector('#search-mobile-container'),q=document.querySelector('#search-mobile-results'),v=document.querySelector('html'),J&&(J.style.display='none'),S?S.forEach(function(a,b){a.addEventListener('click',function(){u&&(u.style.display='block'),n&&n.focus(),v&&(v.style.overflowY='hidden')})}):null,T?T.addEventListener('click',function(){if(u&&(u.style.display='none'),n&&(n.value=''),q)while(q.firstChild)q.removeChild(q.firstChild);v&&(v.style.overflowY='visible')}):null,n?n.addEventListener('keydown',function(a){var b=a.which||a.keyCode;if(a.key==='Escape'||b===27){if(u&&(u.style.display='none'),n&&(n.value=''),q)while(q.firstChild)q.removeChild(q.firstChild);v&&(v.style.overflowY='visible')}}):null;function N(d,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');d?a&&a&&a.length&&(a.forEach(function(a){ai(c,a)}),e?e.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}function _(d,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),c=document.createElement('ul');d?a&&a&&a.length&&(a.forEach(function(a){$(c,a)}),e?e.setAttribute('data-display','block'):null,f?f.setAttribute('data-display','none'):null):(e?e.setAttribute('data-display','none'):null,f?f.setAttribute('data-display','block'):null),b.parentNode.replaceChild(c,b)}})</script>
<link rel=stylesheet href=/css/main.min.css>
<meta name=description content="本文结合源码，分析了Java并发框架中用于执行计划任务的执行器(ScheduledThreadPoolExecutor)的运行机制。是执行器的姊妹篇。">
<meta name=keywords content="线程池,执行器">
<meta name=created content="2020-11-10T00:00:00+0000">
<meta name=modified content="2022-12-09T03:43:41+0000">
<meta property="article:published_time" content="2020-11-10T00:00:00+0000">
<meta name=author content="wangy325">
<meta property="article:author" content="https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/@wangy325">
<meta property="og:site_name" content="EndlessRiver">
<meta property="og:title" content="Java并发系列之8——计划执行任务">
<meta property="og:url" content="https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/">
<meta property="og:type" content="article">
<meta property="og:description" content="本文结合源码，分析了Java并发框架中用于执行计划任务的执行器(ScheduledThreadPoolExecutor)的运行机制。是执行器的姊妹篇。">
<meta name=generator content="Hugo 0.87.0">
<meta name=msapplication-TileColor content="#fff">
<meta name=theme-color content="#fff">
<meta name=msapplication-navbutton-color content="#fff">
<meta name=apple-mobile-web-app-status-bar-style content="#fff">
<link rel=canonical href=https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/>
<link rel=manifest href=/manifest.json>
<link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png>
<link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png>
<link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png>
<link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png>
<link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png>
<link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png>
<link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png>
<link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png>
<link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png>
<link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png>
<link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png>
<meta name=msapplication-TileColor content="#ffffff">
<meta name=msapplication-TileImage content="/ms-icon-144x144.png">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","headline":"Java并发系列之8——计划执行任务","datePublished":"2020-11-10T00:00:00Z","dateModified":"2022-12-09T03:43:41Z","url":"https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/","description":"本文结合源码，分析了Java并发框架中用于执行计划任务的执行器(ScheduledThreadPoolExecutor)的运行机制。是执行器的姊妹篇。","keywords":["线程池","执行器"],"author":{"@type":"Person","name":"wangy325"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangy325.github.io"},"publisher":{"@type":"Organization","name":"EndlessRiver","url":"https://wangy325.github.io"}}</script>
<script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
</head>
<body id=root class=theme__light>
<script>var localTheme=localStorage.getItem('theme');localTheme&&(document.getElementById('root').className='theme__'+localTheme)</script>
<div id=container>
<div class=wrapper data-type=posts data-kind=page>
<nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr>
<div class=navbar__brand>
<a href=/zh/ title=主页 rel=home class=navbar__logo-link>
<img src=/logo.png alt=Home class=navbar__logo>
</a>
<a href=/zh/ title=主页 rel=home class=navbar__title-link>
<h6 class=navbar__title></h6>
</a>
</div>
<div class="theme theme-mobile" data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
light
</a>
<a href=# class="dropdown-item select-theme__item">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
<a href=# class="dropdown-item select-theme__item">
kimbie
</a>
</div>
</div>
</div>
<div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</div>
<div id=search-mobile-container class="mobile-search hide" data-dir=ltr>
<div class=mobile-search__top>
<input id=search-mobile type=text aria-label="Mobile Search" placeholder=搜索 class=mobile-search__top--input>
<div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg>
</div>
</div>
<div id=search-mobile-results class=mobile-search__body>
</div>
</div>
<a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<div class=navbarm__collapse data-open=false>
<ul dir=ltr>
<li class="navbarm__menu--item active">
<a href=/zh/posts>文章</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/archive>归档</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/showcase>代码</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/about>关于</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/friend>友链</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/tags class=navbarm__menu--term data-index=0>
标签
</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/categories class=navbarm__menu--term data-index=1>
分类
</a>
</li>
<li class=navbarm__menu--item>
<a href=/zh/series class=navbarm__menu--term data-index=2>
系列
</a>
</li>
</ul>
</div>
<div class=navbar__menu>
<div class=theme data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
light
</a>
<a href=# class="dropdown-item select-theme__item">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
<a href=# class="dropdown-item select-theme__item">
kimbie
</a>
</div>
</div>
</div>
<a href=/zh/posts class="navbar__menu-item navbar__slide-down active" dir=ltr data-ani=true>文章</a>
<a href=/zh/archive class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>归档</a>
<a href=/zh/showcase class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>代码</a>
<a href=/zh/about class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>关于</a>
<a href=/zh/friend class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>友链</a>
</div>
</nav>
<main class="single__main main">
<nav class="breadcrumb hide" aria-label=breadcrumbs>
<script>document.querySelector('.breadcrumb').classList.remove('hide')</script>
<ol>
<li>
<a href=https://wangy325.github.io/zh/ class=capitalize>EndlessRiver</a>
</li>
<li>
<a href=https://wangy325.github.io/zh/posts/ class=capitalize>文章列表</a>
</li>
<li class=is-active>
<span>Java并发系列之8——计划执行任务</span>
</li>
</ol>
</nav>
<div class=single>
<div class=single__nojs>Please enable Javascript to view the contents</div>
<script>document.querySelector('.single').classList.remove('hide'),document.querySelector('.single__nojs').classList.add('hide')</script>
<h2 class=single__title data-ani=true>Java并发系列之8——计划执行任务</h2>
<h3 class=single__subtitle></h3>
<div class=single__meta>
<div class=single__infos>
<time class=single__info title=创建日期>📅&nbsp;2020年11月10日 </time>
&nbsp;&#183;&nbsp; <time class=single__info title=更新日期> 📝&nbsp;2022年12月09日 </time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长> ☕&nbsp;19&nbsp;分钟 </span>
&nbsp;&#183;&nbsp; <span class=single__info title=作者>✍️&nbsp;wangy325</span>
<span class=single__info>
&#183; 👀<span id=busuanzi_value_page_pv>...</span> 阅读
</span>
</div>
<ul class="single__tags caption">
🏷️
<li><a href=https://wangy325.github.io/zh/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=single__tag title=线程池>#线程池</a></li>
<li><a href=https://wangy325.github.io/zh/tags/%E6%89%A7%E8%A1%8C%E5%99%A8/ class=single__tag title=执行器>#执行器</a></li>
</ul>
</div>
<article class=single__contents data-dir=ltr data-ani=true>
<p>除了ThreadPoolExecutor之外，Java执行器（Executor）框架还提供了可以在指定延迟之后执行一次或周期执行任务的接口<code>ScheduledExecutorService</code>，较<a href=https://docs.oracle.com/javase/8/docs/api/java/util/Timer.html>java.util.Timer</a>而言，它是更好的选择</p>
<p>与<a href=../7%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/#3-%E7%BA%BF%E7%A8%8B%E6%B1%A0>线程池</a>不同的是，用于计划执行的<code>ScheduledThreadPoolExecutor</code>使用<code>ScheduledFutureTask</code>作为任务，使用<code>DelayedWorkQueue</code>作为任务队列，以实现计划（周期）执行的目的</p>
<p><img src=/img/scheduledFutureTask.png alt=xx></p>
<p style=text-align:center;font-size:.9rem;font-style:italic>ScheduledThreadPoolExecutor继承关系图</p>
<p>从<code>ScheduledThreadPoolExecutor</code>的继承关系图可以看到，其是<code>ThreadPoolExecutor</code>的导出类，其提交任务和执行任务以及关闭线程池的逻辑应和线程池相差无几，其重点差别在于<strong>任务对象以及任务队列</strong>的封装上，后文将会详述<code>ScheduledThreadPoolExecutor</code>的任务计划执行以及周期执行机制</p>
<h1 id=1-scheduledexecutorservice>1 ScheduledExecutorService</h1>
<p>继承自<code>ExecutorService</code>接口，其方法定义了一个可以用于在指定延迟之后执行一次或周期执行的ExecutorService</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// 继承自ExecutorService 和Executor的方法被省略
</span><span class=c1></span>
<span class=cm>/* 在给定的延迟之后执行Callable任务，立即返回ScheduledFuture&lt;V&gt;，其可以获取任务的结果或者取消任务*/</span>
<span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>ScheduledFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=nf>schedule</span><span class=o>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>callable</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span>

<span class=cm>/* 在给定的延迟之后执行Runnable任务，立即返回ScheduledFuture&lt;?&gt;，其get()方法返回null*/</span>
<span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>schedule</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span>

<span class=cm>/* 在给定的初始延迟initialDelay之后执行Runnable任务，接着在给定的时间间隔period之后再次执行任务，
</span><span class=cm>接着再间隔period之后再次执行任务...
</span><span class=cm>
</span><span class=cm>如果某次任务的执行耗时 &gt; period，下次的计划执行将被延后，并不会同时执行多个任务
</span><span class=cm>
</span><span class=cm>如果某次执行抛出异常，那么接下来的执行将被中止。周期执行的任务只有线程池终止之后才会停止执行，也
</span><span class=cm>就是说周期任务永远不会主动完成
</span><span class=cm>
</span><span class=cm>返回值ScheduledFuture&lt;?&gt;代表将要执行的任务，取消任务时，其get()方法会抛出异常*/</span>
<span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>scheduleAtFixedRate</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span> <span class=kt>long</span> <span class=n>initialDelay</span><span class=o>,</span>
                                        <span class=kt>long</span> <span class=n>period</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span>

<span class=cm>/* 在给定的初始延迟之后执行Runnable任务，接着在任务完成之后延迟delay之后再次执行，接着在上一个
</span><span class=cm>任务完成之后延迟delay再次执行...
</span><span class=cm>
</span><span class=cm>如果某次执行抛出异常，那么接下来的执行将被中止。周期执行的任务只有线程池终止之后才会停止执行，也
</span><span class=cm>就是说周期任务永远不会主动完成
</span><span class=cm>
</span><span class=cm>返回值ScheduledFuture&lt;?&gt;代表将要执行的任务，取消任务时，其get()方法会抛出异常*/</span>
<span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>scheduleWithFixedDelay</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span> <span class=kt>long</span> <span class=n>initialDelay</span><span class=o>,</span>
                                            <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id=2-scheduledthreadpoolexecutor>2 ScheduledThreadPoolExecutor</h1>
<p>由于其是<code>ThreadPoolExecutor</code>的导出类，故其主要逻辑和其父类一致，本节的讨论着重于二者差异的部分</p>
<h2 id=21-构造器>2.1 构造器</h2>
<p><code>ScheduledThreadPoolExecutor</code>的构造器就不再赘述了，基本上是父类的构造参数中抽取了几个便于理解的构造器，将其分列如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=nf>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>NANOSECONDS</span><span class=o>,</span>
          <span class=k>new</span> <span class=n>DelayedWorkQueue</span><span class=o>());</span>
<span class=o>}</span>
<span class=kd>public</span> <span class=nf>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
                               <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>NANOSECONDS</span><span class=o>,</span>
          <span class=k>new</span> <span class=n>DelayedWorkQueue</span><span class=o>(),</span> <span class=n>threadFactory</span><span class=o>);</span>
<span class=o>}</span>
<span class=kd>public</span> <span class=nf>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
                                   <span class=n>RejectedExecutionHandler</span> <span class=n>handler</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>NANOSECONDS</span><span class=o>,</span>
          <span class=k>new</span> <span class=n>DelayedWorkQueue</span><span class=o>(),</span> <span class=n>handler</span><span class=o>);</span>
<span class=o>}</span>
<span class=kd>public</span> <span class=nf>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>,</span>
                                   <span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=o>,</span>
                                   <span class=n>RejectedExecutionHandler</span> <span class=n>handler</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>MAX_VALUE</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>NANOSECONDS</span><span class=o>,</span>
          <span class=k>new</span> <span class=n>DelayedWorkQueue</span><span class=o>(),</span> <span class=n>threadFactory</span><span class=o>,</span> <span class=n>handler</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ScheduledThreadPoolExecutor</code>的实例均使用Integer.MAX_VALUE作为最大线程池数，这是否意味着其可以使用无限制的线程去运行任务呢？答案是否定的，<code>ScheduledThreadPoolExecutor</code>保证了其池中的线程数不会超过<code>corePoolSize</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<h2 id=22-域>2.2 域</h2>
<p>除了构造器中指定的参数之外，<code>ScheduledThreadPoolExecutor</code>还有一些其他参数，这些参数都可以在<code>ScheduledThreadPoolExecutor</code>初始化完成之后再进行动态配置</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=cm>/** 线程池shutdown之后是否继续执行周期任务，true执行，默认为false*/</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>continueExistingPeriodicTasksAfterShutdown</span><span class=o>;</span>

<span class=cm>/** 线程池shutdown之后是否继续执行计划任务，true执行，默认为true*/</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>executeExistingDelayedTasksAfterShutdown</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>

<span class=cm>/** 取消任务时是否将任务从队列中移除，true移除，默认false*/</span>
<span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>removeOnCancel</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>

<span class=cm>/** 任务添加的顺序，初始化ScheduledFutureTask时使用*/</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>AtomicLong</span> <span class=n>sequencer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicLong</span><span class=o>();</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=23-方法>2.3 方法</h2>
<p><code>ScheduledThreadPoolExecutor</code>使用最多的还是实现自<code>ScheduledExecutorService</code>接口的4个方法，用于计划（周期）执行任务，其中，作为线程池的execute和submit方法全部直接调用了scheduleXX方法。值得一提的是，<code>ScheduledThreadPoolExecutor</code>覆盖了<code>ThreadPoolExecutor</code>的<code>onShutdown()</code>方法，用于关闭线程池时的额外操作，该方法在父类中是空方法</p>
<h2 id=24-由executors构造的scheduledthreadpoolexecutor>2.4 由Executors构造的ScheduledThreadPoolExecutor</h2>
<p>一般地，我们会使用<code>Executors</code>来获取线程池，<code>Executors</code>提供了2个基本方法(不包括重载方法)来获取计划执行任务的线程池</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=cm>/** 构造一个不可动态配置的ScheduledThreadPoolExecutor，其核心线程池数量为1*/</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>ScheduledExecutorService</span> <span class=nf>newSingleThreadScheduledExecutor</span><span class=o>()</span> <span class=o>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>DelegatedScheduledExecutorService</span>
        <span class=o>(</span><span class=k>new</span> <span class=n>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=n>1</span><span class=o>));</span>
<span class=o>}</span>

<span class=cm>/** 构造一个核心线程池为1的ScheduledThreadPoolExecutor*/</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>ScheduledExecutorService</span> <span class=nf>newScheduledThreadPool</span><span class=o>(</span><span class=kt>int</span> <span class=n>corePoolSize</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=n>corePoolSize</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们可以自定义线程工厂(ThreadFactory)来调用其重载方法以自定义线程信息</p>
<h1 id=3-内部结构>3 内部结构</h1>
<h2 id=31-scheduledfuturetask>3.1 ScheduledFutureTask</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kd>class</span> <span class=nc>ScheduledFutureTask</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span>
            <span class=kd>extends</span> <span class=n>FutureTask</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>RunnableScheduledFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span>
            <span class=o>{...}</span>
</code></pre></td></tr></table>
</div>
</div><p>提交给<code>ScheduledExecutorService</code>的任务都被包装成<code>ScheduledFutureTask</code>实例，相较FutureTask，其还实现了<code>RunnableScheduledFuture</code>接口，这个接口是RunnableFuture，ScheduledFuture的子接口，也就是Runnable，Future和Delay的实现类</p>
<p>实现Delay接口是关键，它保证计划任务能够按时（周期）执行，并且任务能够按照执行顺序或者添加顺序被取出执行</p>
<h3 id=311-域>3.1.1 域</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// 每一个实例都有一个“序号”，用来维持其在队列中的位置
</span><span class=c1></span><span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>sequenceNumber</span><span class=o>;</span>

<span class=c1>// 任务下一次执行的时间，纳秒表示
</span><span class=c1></span><span class=kd>private</span> <span class=kt>long</span> <span class=n>time</span><span class=o>;</span>

<span class=c1>// 任务周期执行的“周期”，纳秒表示，正数表示固定频率执行；
</span><span class=c1>// 负数表示固定延迟执行，0表示不是周期执行的任务
</span><span class=c1></span><span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>period</span><span class=o>;</span>

<span class=c1>// 用来重新插入队列中的任务 （周期执行的任务）
</span><span class=c1></span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>outerTask</span> <span class=o>=</span> <span class=k>this</span><span class=o>;</span>

<span class=c1>// 任务在队列中的索引（看出来是一个树）
</span><span class=c1></span><span class=kt>int</span> <span class=n>heapIndex</span><span class=o>;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=312-构造器>3.1.2 构造器</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// 构造一个单次执行的任务
</span><span class=c1></span><span class=n>ScheduledFutureTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=n>V</span> <span class=n>result</span><span class=o>,</span> <span class=kt>long</span> <span class=n>ns</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>time</span> <span class=o>=</span> <span class=n>ns</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>period</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>sequenceNumber</span> <span class=o>=</span> <span class=n>sequencer</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>();</span>
<span class=o>}</span>
<span class=c1>// 构造单次执行的任务
</span><span class=c1></span><span class=n>ScheduledFutureTask</span><span class=o>(</span><span class=n>Callable</span><span class=o>&lt;</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>callable</span><span class=o>,</span> <span class=kt>long</span> <span class=n>ns</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>callable</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>time</span> <span class=o>=</span> <span class=n>ns</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>period</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>sequenceNumber</span> <span class=o>=</span> <span class=n>sequencer</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>();</span>
<span class=o>}</span>
<span class=c1>// 构造周期执行的任务
</span><span class=c1></span><span class=n>ScheduledFutureTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=o>,</span> <span class=n>V</span> <span class=n>result</span><span class=o>,</span> <span class=kt>long</span> <span class=n>ns</span><span class=o>,</span> <span class=kt>long</span> <span class=n>period</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=n>r</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>time</span> <span class=o>=</span> <span class=n>ns</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>period</span> <span class=o>=</span> <span class=n>period</span><span class=o>;</span>
    <span class=k>this</span><span class=o>.</span><span class=na>sequenceNumber</span> <span class=o>=</span> <span class=n>sequencer</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>();</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>前2个构造器构造单次执行的任务，不过使用的任务不同罢了；第三个构造器构造周期执行的任务。每构造一个任务，任务的<code>sequenceNumber</code>便自增1</p>
<h3 id=313-方法>3.1.3 方法</h3>
<h4 id=1-compareto><strong>1 compareTo</strong></h4>
<p>由于Delay接口实现了Comparable接口，因此实现此方法对任务进行排序，其排序规则是：</p>
<ul>
<li>先比较<code>time</code>，先执行的任务在前</li>
<li>若<code>time</code>相等，再比较<code>sequenceNumber</code>，先添加的任务在</li>
</ul>
<h4 id=2-setnextruntime><strong>2 setNextRunTime</strong></h4>
<p>设置周期任务下一次执行的时间</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kt>void</span> <span class=nf>setNextRunTime</span><span class=o>()</span> <span class=o>{</span>
   <span class=kt>long</span> <span class=n>p</span> <span class=o>=</span> <span class=n>period</span><span class=o>;</span>
   <span class=k>if</span> <span class=o>(</span><span class=n>p</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span>
       <span class=c1>//  固定周期执行，上一次执行时间+period即可
</span><span class=c1></span>       <span class=n>time</span> <span class=o>+=</span> <span class=n>p</span><span class=o>;</span>
   <span class=k>else</span>
       <span class=c1>// 固定delay执行
</span><span class=c1></span>       <span class=n>time</span> <span class=o>=</span> <span class=n>triggerTime</span><span class=o>(-</span><span class=n>p</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=3-run><strong>3 run</strong></h4>
<p>执行任务的核心方法</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
    <span class=c1>// 检查是否周期任务
</span><span class=c1></span>    <span class=kt>boolean</span> <span class=n>periodic</span> <span class=o>=</span> <span class=n>isPeriodic</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(!</span><span class=n>canRunInCurrentRunState</span><span class=o>(</span><span class=n>periodic</span><span class=o>))</span>
        <span class=c1>// 当前状态不允许运行任务
</span><span class=c1></span>        <span class=n>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=k>else</span> <span class=k>if</span> <span class=o>(!</span><span class=n>periodic</span><span class=o>)</span>
        <span class=c1>// 执行单次任务
</span><span class=c1></span>        <span class=n>ScheduledFutureTask</span><span class=o>.</span><span class=na>super</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
    <span class=c1>// 执行周期任务使用了runAndReset方法
</span><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>ScheduledFutureTask</span><span class=o>.</span><span class=na>super</span><span class=o>.</span><span class=na>runAndReset</span><span class=o>())</span> <span class=o>{</span>
        <span class=c1>// 周期任务执行完毕一次
</span><span class=c1></span>        <span class=c1>// 设置下次执行的时间
</span><span class=c1></span>        <span class=n>setNextRunTime</span><span class=o>();</span>
        <span class=c1>// 将任务添加到队列
</span><span class=c1></span>        <span class=n>reExecutePeriodic</span><span class=o>(</span><span class=n>outerTask</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>

<span class=c1>// 将已经执行的任务再次放入任务队列中
</span><span class=c1></span><span class=kt>void</span> <span class=nf>reExecutePeriodic</span><span class=o>(</span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>canRunInCurrentRunState</span><span class=o>(</span><span class=kc>true</span><span class=o>))</span> <span class=o>{</span>
        <span class=c1>// 再次入队
</span><span class=c1></span>        <span class=kd>super</span><span class=o>.</span><span class=na>getQueue</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
        <span class=c1>// double check
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>canRunInCurrentRunState</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=n>remove</span><span class=o>(</span><span class=n>task</span><span class=o>))</span>
            <span class=c1>// 取消任务
</span><span class=c1></span>            <span class=n>task</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
        <span class=k>else</span>
            <span class=c1>// 创建（如果需要）worker，保证有线程执行任务
</span><span class=c1></span>            <span class=n>ensurePrestart</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=32-delayedworkqueue>3.2 DelayedWorkQueue</h2>
<p><code>ScheduledThreadPoolExecutor</code>使用<code>DeleyedWorkQueue</code>作为任务队列，它是一个特殊的<em><strong>delay queue</strong></em>，其维护一个有序的<code>ScheduledFutureTask</code>任务队列。在本节中，限于数据结构相关知识尚缺，将跳过叙述队列中的元素如何调整其在树中的位置，着重叙述任务入队及出队的逻辑</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>static</span> <span class=kd>class</span> <span class=nc>DelayedWorkQueue</span> <span class=kd>extends</span> <span class=n>AbstractQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span>
        <span class=kd>implements</span> <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=o>{</span>
        <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>该类中，有一个核心概念，它用一个私有域表示</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// 这个域用来等待队列的队首元素出现
</span><span class=c1></span><span class=kd>private</span> <span class=n>Thread</span> <span class=n>leader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</code></pre></td></tr></table>
</div>
</div><p>在<em>delay queue</em> 中，如果没有元素的delay超时，那么你将无法从队列中取出元素。当某个任务A的delay最先超时时，其将优先出队并执行，那么<code>leader</code>将被声明为执行任务A的线程TA，在该任务A超时之前，leader不会被重置，在这一段时间内，其他线程只能等待；若任务A超时出队，leader将被重置，此时线程TA将唤醒等待的其他线程，然后重复重置leader的过程。我们将在任务入队和出队时看到<code>leader</code>域的作用</p>
<h1 id=4-任务执行流程>4 任务执行流程</h1>
<p>前面介绍了<code>ScheduledFutureTask</code>和<code>DeleyedWorkQueue</code>这么多，都是为了更好地理解任务执行的流程，在这之前，我们不妨先看如下示例：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TestScheduledPoolExecutor</span> <span class=o>{</span>

    <span class=kd>private</span> <span class=n>AtomicInteger</span> <span class=n>sequence</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicInteger</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>

    <span class=kd>private</span> <span class=n>ScheduledThreadPoolExecutor</span> <span class=n>service</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>TestScheduledPoolExecutor</span><span class=o>(</span><span class=kt>int</span> <span class=n>poolSize</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>service</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledThreadPoolExecutor</span><span class=o>(</span><span class=n>poolSize</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>s</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; &#34;</span> <span class=o>+</span> <span class=n>sequence</span><span class=o>.</span><span class=na>getAndIncrement</span><span class=o>());</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=kt>void</span> <span class=nf>c</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; c running&#34;</span><span class=o>);</span>
        <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
            <span class=c1>// never finish loop unless interrupted
</span><span class=c1></span>            <span class=k>if</span> <span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>interrupted</span><span class=o>())</span> <span class=o>{</span>
                <span class=k>break</span><span class=o>;</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;c interrupted&#34;</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@SneakyThrows</span>
    <span class=kt>void</span> <span class=nf>basicTest</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
        <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>c</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
        <span class=c1>// shutdown无法终止线程池
</span><span class=c1></span>        <span class=n>service</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
        <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>5</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>exit</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>TestScheduledPoolExecutor</span> <span class=n>ts</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TestScheduledPoolExecutor</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
        <span class=n>ts</span><span class=o>.</span><span class=na>basicTest</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在上例中，我们创建了2个任务s和c，前者简单地获取并递增sequence，后者则是一个响应中断的死循环。当我们使用不同数量的<code>corePoolSize</code>去运行任务时，得到的结果不一样:</p>
<blockquote>
<p>当corePoolSize = 0时，输出为</p>
</blockquote>
<pre><code>Thread[pool-1-thread-1,5,main] c running
</code></pre>
<blockquote>
<p>当corePoolSize = 1时，输出为</p>
</blockquote>
<pre><code>Thread[pool-1-thread-1,5,main] c running
</code></pre>
<blockquote>
<p>当corePoolSize > 1时，输出为</p>
</blockquote>
<pre><code>Thread[pool-1-thread-1,5,main] c running
Thread[pool-1-thread-2,5,main] 1
</code></pre><h2 id=41-提交任务>4.1 提交任务</h2>
<p>这种差异驱使我们去探索计划任务的提交与执行方式：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=c1>// 提交单次执行的任务
</span><span class=c1></span><span class=kd>public</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>schedule</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span>
                                  <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span>
                                  <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span> <span class=o>{</span>
   <span class=k>if</span> <span class=o>(</span><span class=n>command</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>unit</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
       <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>();</span>
   <span class=c1>// t = new ScheduledFutureTask(..)
</span><span class=c1></span>   <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=n>decorateTask</span><span class=o>(</span><span class=n>command</span><span class=o>,</span>
       <span class=k>new</span> <span class=n>ScheduledFutureTask</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;(</span><span class=n>command</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span>
                                     <span class=n>triggerTime</span><span class=o>(</span><span class=n>delay</span><span class=o>,</span> <span class=n>unit</span><span class=o>)));</span>
   <span class=c1>// 执行任务的核心方法
</span><span class=c1></span>   <span class=n>delayedExecute</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
   <span class=k>return</span> <span class=n>t</span><span class=o>;</span>
<span class=o>}</span>

<span class=c1>// 提交周期执行的任务
</span><span class=c1></span><span class=kd>public</span> <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>scheduleWithFixedDelay</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>command</span><span class=o>,</span>
                                                 <span class=kt>long</span> <span class=n>initialDelay</span><span class=o>,</span>
                                                 <span class=kt>long</span> <span class=n>delay</span><span class=o>,</span>
                                                 <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>command</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>unit</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>delay</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>();</span>
    <span class=n>ScheduledFutureTask</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>sft</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>ScheduledFutureTask</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;(</span><span class=n>command</span><span class=o>,</span>
                                      <span class=kc>null</span><span class=o>,</span>
                                      <span class=n>triggerTime</span><span class=o>(</span><span class=n>initialDelay</span><span class=o>,</span> <span class=n>unit</span><span class=o>),</span>
                                      <span class=n>unit</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(-</span><span class=n>delay</span><span class=o>));</span>
    <span class=c1>// t = sft
</span><span class=c1></span>    <span class=n>RunnableScheduledFuture</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>t</span> <span class=o>=</span> <span class=n>decorateTask</span><span class=o>(</span><span class=n>command</span><span class=o>,</span> <span class=n>sft</span><span class=o>);</span>
    <span class=c1>// 任务执行后将再次入队
</span><span class=c1></span>    <span class=n>sft</span><span class=o>.</span><span class=na>outerTask</span> <span class=o>=</span> <span class=n>t</span><span class=o>;</span>
    <span class=n>delayedExecute</span><span class=o>(</span><span class=n>t</span><span class=o>);</span>
    <span class=k>return</span> <span class=n>t</span><span class=o>;</span>
<span class=o>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>delayedExecute</span><span class=o>(</span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
   <span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>())</span>
        <span class=c1>// ctl &gt; running，不接受任务提交
</span><span class=c1></span>       <span class=n>reject</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
   <span class=k>else</span> <span class=o>{</span>
       <span class=c1>// 非空任务入队
</span><span class=c1></span>       <span class=kd>super</span><span class=o>.</span><span class=na>getQueue</span><span class=o>().</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
       <span class=c1>// double check
</span><span class=c1></span>       <span class=k>if</span> <span class=o>(</span><span class=n>isShutdown</span><span class=o>()</span> <span class=o>&amp;&amp;</span>
           <span class=o>!</span><span class=n>canRunInCurrentRunState</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>isPeriodic</span><span class=o>())</span> <span class=o>&amp;&amp;</span>
           <span class=n>remove</span><span class=o>(</span><span class=n>task</span><span class=o>))</span>
           <span class=c1>// 如果任务入队之后，线程池关闭
</span><span class=c1></span>           <span class=c1>// 且关闭策略不允许关闭之后继续执行
</span><span class=c1></span>           <span class=c1>// 且任务从队列中移除
</span><span class=c1></span>           <span class=c1>// 则取消任务
</span><span class=c1></span>           <span class=n>task</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
       <span class=k>else</span>
           <span class=c1>// add worker
</span><span class=c1></span>           <span class=n>ensurePrestart</span><span class=o>();</span>
   <span class=o>}</span>
<span class=o>}</span>

<span class=c1>// 此方法保证了即使corePoolSize = 0的情况下也创建worker
</span><span class=c1></span><span class=kt>void</span> <span class=nf>ensurePrestart</span><span class=o>()</span> <span class=o>{</span>
    <span class=c1>// 获取当前工作线程数
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>wc</span> <span class=o>=</span> <span class=n>workerCountOf</span><span class=o>(</span><span class=n>ctl</span><span class=o>.</span><span class=na>get</span><span class=o>());</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>wc</span> <span class=o>&lt;</span> <span class=n>corePoolSize</span><span class=o>)</span>
        <span class=c1>// 尚可以新建核心线程
</span><span class=c1></span>        <span class=n>addWorker</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
    <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>wc</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span>
        <span class=c1>// 新建非核心线程
</span><span class=c1></span>        <span class=n>addWorker</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><center>
![xx](/img/scheduledThreadPool_submit_flow.png)
<p style=text-align:center;font-size:.9rem;font-style:italic>ScheduledThreadPoolExecutor任务提交流程图</p>
</center>
<p>我们可以从<code>ScheduledThreadPoolExecutor</code>的任务提交过程中总结几点规律：</p>
<ol>
<li>任务一定是先放入任务队列中的</li>
<li>活动线程不可能超过核心线程池大小</li>
<li>若<code>corePoolSize</code> > 0，则池中不可能存在非核心线程</li>
<li>非核心线程只有在<code>corePoolSize</code> = 0且当前工作线程数为0时才可以创建，<del>并且活动的非核心线程<strong>只能存在一个</strong></del></li>
</ol>
<p>上述规律的第4点容易得出线程池中<strong>非核心线程数至多为1</strong>的结论，这似乎是很合理的，因为想要创建非核心线程，wc必须为0。结合线程池的相关知识，我们知道非核心线程超时是会被销毁的，我们可以看看非核心线程在执行计划任务时的行为</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@SneakyThrows</span>
<span class=kt>void</span> <span class=nf>howManyThreads</span><span class=o>()</span> <span class=o>{</span>
    <span class=k>for</span> <span class=o>(;</span> <span class=o>;</span> <span class=o>)</span> <span class=o>{</span>
        <span class=n>ScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>schedule</span> <span class=o>=</span> <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>);</span>
        <span class=c1>// TimeUnit.MILLISECONDS.sleep(5); // uncomment this to create new worker
</span><span class=c1></span>        <span class=k>for</span> <span class=o>(;</span> <span class=o>;</span> <span class=o>)</span> <span class=o>{</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>schedule</span><span class=o>.</span><span class=na>isDone</span><span class=o>())</span>
                <span class=k>break</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>sequence</span><span class=o>.</span><span class=na>get</span><span class=o>()</span> <span class=o>&gt;=</span> <span class=n>10</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>schedule</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
            <span class=k>break</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;largest pool size: &#34;</span> <span class=o>+</span> <span class=n>service</span><span class=o>.</span><span class=na>getLargestPoolSize</span><span class=o>());</span>
    <span class=n>service</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
<span class=o>}</span>
<span class=cm>/* output(sample)
</span><span class=cm>Thread[pool-1-thread-1,5,main] 1
</span><span class=cm>Thread[pool-1-thread-1,5,main] 2
</span><span class=cm>Thread[pool-1-thread-1,5,main] 3
</span><span class=cm>Thread[pool-1-thread-2,5,main] 4
</span><span class=cm>Thread[pool-1-thread-3,5,main] 5
</span><span class=cm>Thread[pool-1-thread-4,5,main] 6
</span><span class=cm>Thread[pool-1-thread-5,5,main] 7
</span><span class=cm>Thread[pool-1-thread-7,5,main] 8
</span><span class=cm>Thread[pool-1-thread-8,5,main] 9
</span><span class=cm>Thread[pool-1-thread-10,5,main] 10
</span><span class=cm>largest pool size: 2
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>在上例中，我们保证当前提交的任务在执行完成之后再进行下一次提交，那么下一次的任务应该新建线程执行才对。但实际的情况并非如此，执行上个任务的线程仍然有机会继续执行接下来提交的任务，这是由于任务的执行以及线程的销毁都是耗时操作，可能在线程销毁（执行CP1）之前新的任务已经添加到队列中了。除此之外，在所有任务执行完成之后，我们获取了线程池中同时执行任务的最大线程数，按照逻辑，这个值应该始终是1，实际的运行过程中却是一个不确定的数。这让人费解，新线程的创建前提是<code>workerCount==0</code>，即表明了池中是没有正在运行的线程，不过，可以猜测池中出现2个线程的过程大概出现在线程1即将销毁，执行<a href=../%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/#3-2-3-%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1>processWorkerExit</a>方法之前，将要销毁的worker还未从set中移除，而此时addworker读取到的size > 1，于是出现了largestPoolSie>1的情形。</p>
<p>如果取消上例中的休眠注释，就能规避上述的各种不确定情况，足够时长的休眠可以保证执行任务的线程执行任务并销毁。</p>
<h2 id=42-任务入队>4.2 任务入队</h2>
<p>由于任务提交之后一定是先放入任务队列的，而基于<code>DelayedWorkQueue</code>的任务队列和普通的阻塞队列有些区别。任务队列通过调用<code>offer(Runnable x)</code>方法将任务放入队列中，只有在获取锁的情况下才能调用</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>offer</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>x</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>x</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=o>();</span>
    <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>e</span> <span class=o>=</span> <span class=o>(</span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;)</span><span class=n>x</span><span class=o>;</span>
    <span class=kd>final</span> <span class=n>ReentrantLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>lock</span><span class=o>;</span>
    <span class=n>lock</span><span class=o>.</span><span class=na>lock</span><span class=o>();</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>size</span><span class=o>;</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>&gt;=</span> <span class=n>queue</span><span class=o>.</span><span class=na>length</span><span class=o>)</span>
            <span class=c1>// 队列扩容 （grow 50%）
</span><span class=c1></span>            <span class=n>grow</span><span class=o>();</span>
        <span class=n>size</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>1</span><span class=o>;</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>;</span>
            <span class=n>setIndex</span><span class=o>(</span><span class=n>e</span><span class=o>,</span> <span class=n>0</span><span class=o>);</span>
        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
            <span class=n>siftUp</span><span class=o>(</span><span class=n>i</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
        <span class=o>}</span>
        <span class=c1>// 入队之前，若队列为空，且没有线程在超时等待
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(</span><span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>==</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>leader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
            <span class=c1>// 唤醒等待的线程去获取任务执行（并非一定有线程等待）
</span><span class=c1></span>            <span class=n>available</span><span class=o>.</span><span class=na>signal</span><span class=o>();</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于使用无界队列实现，<code>DelayedWorkQueue</code>任务入队的阻塞不会阻塞；但如果入队时队列为空，那么意味着：</p>
<ol>
<li>首个任务入队；</li>
<li>所有任务都已经出队；</li>
</ol>
<p>成功入队之后，将会唤醒一个阻塞的线程(可能没有阻塞的线程)去获取任务执行。</p>
<h2 id=43-执行任务>4.3 执行任务</h2>
<p>与<code>ThreadPoolExecutor</code>不同的是，<code>ScheduledThreadPoolExecutor</code>所有任务都是先添加到任务队列中的，并且任务队列是<em>delay queue</em>，从<em>delay queue</em>中取出任务比简单的阻塞队列稍显复杂。不过其执行任务的基本逻辑和<a href=../%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/#3-2-3-%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1><code>ThreadPoolExecutor</code>的任务执行过程</a>是一致的</p>
<p>而关于任务周期执行的机制，前文在阐述<a href=#3-run>ScheduledFutureTask</a>的<code>run()</code>方法时，已经提及，</p>
<ul>
<li>它调用<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/FutureTask.html>FutureTask.runAndReset</a>方法执行任务，保证任务可以重复运行；</li>
<li>重新计算任务的下一次运行时间，并且将任务重新入队</li>
</ul>
<h2 id=44-任务出队>4.4 任务出队</h2>
<p>任务出队有主要两个方法，<code>poll(long timeout)</code>和<code>take()</code>，前者用于非核心线程，后者用于核心线程；同样地，只有在获取锁的时候才能出队</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span><span class=lnt>99
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>take</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
    <span class=kd>final</span> <span class=n>ReentrantLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>lock</span><span class=o>;</span>
    <span class=c1>// 注意此处可以被中断
</span><span class=c1></span>    <span class=n>lock</span><span class=o>.</span><span class=na>lockInterruptibly</span><span class=o>();</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=c1>// 循环执行
</span><span class=c1></span>        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
            <span class=c1>// queue[0]是最先超时的任务
</span><span class=c1></span>            <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>first</span> <span class=o>=</span> <span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>first</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span>
                <span class=c1>// 队列为空，无限期等待，会被offer()方法唤醒
</span><span class=c1></span>                <span class=n>available</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
            <span class=k>else</span> <span class=o>{</span>
                <span class=kt>long</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>first</span><span class=o>.</span><span class=na>getDelay</span><span class=o>(</span><span class=n>NANOSECONDS</span><span class=o>);</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>delay</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
                    <span class=c1>// 任务已超时，返回该任务
</span><span class=c1></span>                    <span class=k>return</span> <span class=n>finishPoll</span><span class=o>(</span><span class=n>first</span><span class=o>);</span>
                <span class=n>first</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>// don&#39;t retain ref while waiting
</span><span class=c1></span>                <span class=c1>// 任务未超时
</span><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
                    <span class=c1>// 当leader已设置时，当前线程只能无限期等待
</span><span class=c1></span>                    <span class=c1>// 因为在其之前还有任务未执行
</span><span class=c1></span>                    <span class=n>available</span><span class=o>.</span><span class=na>await</span><span class=o>();</span>
                <span class=k>else</span> <span class=o>{</span>
                    <span class=c1>// 否则将leader设置为当前（执行任务的）线程
</span><span class=c1></span>                    <span class=n>Thread</span> <span class=n>thisThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
                    <span class=n>leader</span> <span class=o>=</span> <span class=n>thisThread</span><span class=o>;</span>
                    <span class=k>try</span> <span class=o>{</span>
                        <span class=c1>// 等待任务超时
</span><span class=c1></span>                        <span class=n>available</span><span class=o>.</span><span class=na>awaitNanos</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
                    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
                        <span class=c1>// 任务超时之后，将leader置空，再次进入循环
</span><span class=c1></span>                        <span class=c1>// 之后将获取任务并返回
</span><span class=c1></span>                        <span class=c1>// 此时其他的线程将可以设置leader并进入超时等待
</span><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=n>thisThread</span><span class=o>)</span>
                            <span class=n>leader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
            <span class=c1>//唤醒其他的线程去获取任务
</span><span class=c1></span>            <span class=n>available</span><span class=o>.</span><span class=na>signal</span><span class=o>();</span>
        <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>poll</span><span class=o>(</span><span class=kt>long</span> <span class=n>timeout</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>unit</span><span class=o>)</span>
    <span class=kd>throws</span> <span class=n>InterruptedException</span> <span class=o>{</span>
    <span class=c1>// nanos如果不进行动态配置，就是0
</span><span class=c1></span>    <span class=kt>long</span> <span class=n>nanos</span> <span class=o>=</span> <span class=n>unit</span><span class=o>.</span><span class=na>toNanos</span><span class=o>(</span><span class=n>timeout</span><span class=o>);</span>
    <span class=kd>final</span> <span class=n>ReentrantLock</span> <span class=n>lock</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>lock</span><span class=o>;</span>
    <span class=n>lock</span><span class=o>.</span><span class=na>lockInterruptibly</span><span class=o>();</span>
    <span class=k>try</span> <span class=o>{</span>
        <span class=k>for</span> <span class=o>(;;)</span> <span class=o>{</span>
            <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>first</span> <span class=o>=</span> <span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>];</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>first</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>nanos</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
                    <span class=c1>// 若队列为空，且keepAliveTime&lt;=0，直接返回null
</span><span class=c1></span>                    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
                <span class=k>else</span>
                    <span class=c1>// 否则限时等待之后进入下次循环
</span><span class=c1></span>                    <span class=n>nanos</span> <span class=o>=</span> <span class=n>available</span><span class=o>.</span><span class=na>awaitNanos</span><span class=o>(</span><span class=n>nanos</span><span class=o>);</span>
            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
                <span class=kt>long</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>first</span><span class=o>.</span><span class=na>getDelay</span><span class=o>(</span><span class=n>NANOSECONDS</span><span class=o>);</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>delay</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
                    <span class=c1>// 运气好正好有任务到期，返回任务
</span><span class=c1></span>                    <span class=k>return</span> <span class=n>finishPoll</span><span class=o>(</span><span class=n>first</span><span class=o>);</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>nanos</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span>
                    <span class=c1>// 任务未到期且keepAliveTime&lt;=0，返回null
</span><span class=c1></span>                    <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
                <span class=n>first</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span> <span class=c1>// don&#39;t retain ref while waiting
</span><span class=c1></span>                <span class=c1>// 以下是设置keepAliveTime的情形
</span><span class=c1></span>                <span class=k>if</span> <span class=o>(</span><span class=n>nanos</span> <span class=o>&lt;</span> <span class=n>delay</span> <span class=o>||</span> <span class=n>leader</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
                    <span class=c1>// 将nanos置0
</span><span class=c1></span>                    <span class=n>nanos</span> <span class=o>=</span> <span class=n>available</span><span class=o>.</span><span class=na>awaitNanos</span><span class=o>(</span><span class=n>nanos</span><span class=o>);</span>
                <span class=k>else</span> <span class=o>{</span>
                    <span class=n>Thread</span> <span class=n>thisThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=o>.</span><span class=na>currentThread</span><span class=o>();</span>
                    <span class=n>leader</span> <span class=o>=</span> <span class=n>thisThread</span><span class=o>;</span>
                    <span class=k>try</span> <span class=o>{</span>
                        <span class=c1>// 分段等待
</span><span class=c1></span>                        <span class=kt>long</span> <span class=n>timeLeft</span> <span class=o>=</span> <span class=n>available</span><span class=o>.</span><span class=na>awaitNanos</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
                        <span class=n>nanos</span> <span class=o>-=</span> <span class=n>delay</span> <span class=o>-</span> <span class=n>timeLeft</span><span class=o>;</span>
                    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
                        <span class=c1>// 重重leader
</span><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=n>thisThread</span><span class=o>)</span>
                            <span class=n>leader</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>leader</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>queue</span><span class=o>[</span><span class=n>0</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span>
            <span class=c1>// 唤醒其他线程
</span><span class=c1></span>            <span class=n>available</span><span class=o>.</span><span class=na>signal</span><span class=o>();</span>
        <span class=n>lock</span><span class=o>.</span><span class=na>unlock</span><span class=o>();</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><center>
![xx](/img/delayed_worker_queue_take.jpg)
<p style=text-align:center;font-size:.9rem;font-style:italic>ScheduledThreadPoolExecutor任务出队流程图</p>
</center>
<p>理解了任务的入队与出队，我们就可以解释<a href=#4-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B>本节开头示例</a>中不同<code>corePoolSize</code>引发的差异：</p>
<p>在分析任务的执行时，要始终留意<code>getTask()</code>方法中的这一段代码，为了方便描述，将其记为<span id=cp1>CP1<span></p>
<blockquote>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=k>if</span> <span class=o>((</span><span class=n>wc</span> <span class=o>&gt;</span> <span class=n>maximumPoolSize</span> <span class=o>||</span> <span class=o>(</span><span class=n>timed</span> <span class=o>&amp;&amp;</span> <span class=n>timedOut</span><span class=o>))</span>
    <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>wc</span> <span class=o>&gt;</span> <span class=n>1</span> <span class=o>||</span> <span class=n>workQueue</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()))</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>compareAndDecrementWorkerCount</span><span class=o>(</span><span class=n>c</span><span class=o>))</span>
        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
    <span class=k>continue</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>当<code>corePoolSize</code>为0时</p>
<ul>
<li>首次提交一个延迟2s的任务a，创建线程t1，显然a超时之前t1无法获取任务，但t1并不会因为keepAlive超时而在CP1处被结束（因为任务队列不为空），它只是一直在循环；</li>
<li>接着提交一个延迟1s的任务b，由于t1未被销毁，所以提交任务b时并未新建线程，池中仍只有一个工作线程t1；</li>
<li>任务b会先于a出队，故1s后b超时执行，由于b是死循环，无法结束，因此没有线程去执行超时的任务a</li>
</ul>
</li>
<li>
<p>当<code>corePoolSize</code>为1时，虽然输出结果与<code>corePoolSize</code>为0时一致，但是其执行过程却有很大差别</p>
<ul>
<li>首次提交一个延迟2s的任务a，创建线程t1，t1会在take()获取队列时设置<code>leader</code>并进入超时等待状态；</li>
<li>接着提交一个延迟1s的任务b，由于<code>corePoolSize</code>的限制，并未能创建新线程，池中仍只有一个工作线程t1。在任务b入队后，会唤醒阻塞的t1线程；</li>
<li>t1被唤醒之后清空<code>leader</code>，重新去队列中获取任务，由于b要比a先出队，此时t1会接着设置<code>leader</code>并在任务b的时间上超时等待；</li>
<li>任务b超时之后开始执行，由于b是死循环，无法结束，因此没有线程去执行超时的任务a</li>
</ul>
</li>
<li>
<p>当<code>corePoolSize</code>> 1时，情况又有所不同</p>
<ul>
<li>首次提交一个延迟2s的任务a，创建线程t1，t1会在take()获取队列时设置<code>leader</code>并进入超时等待状态；</li>
<li>接着提交一个延迟1s的任务b，创建线程t2，池中有2个工作线程t1、t2。同样地，b入队后，会唤醒阻塞的t1；</li>
<li>t1被唤醒之后清空<code>leader</code>，重新去队列中获取任务，由于b要比a先出队，此时t1会接着设置<code>leader</code>并在任务b的时间上超时等待；</li>
<li>t1在超时等待时，由于<code>leader</code>已经被设置，t2只能无限阻塞；</li>
<li>t1超时后，执行任务b，同时清空<code>leader</code>并唤醒t2，t2设置<code>leader</code>并在任务a的时间上超时等待；</li>
<li>t2超时后，执行任务a</li>
</ul>
</li>
</ul>
<h1 id=5-取消任务>5 取消任务</h1>
<p>默认情况下，如果取消一个任务的执行，该任务不会从队列中移除，不过我们可以动态地配置<code>removeOnCancel</code>域，在取消任务时同时将任务从队列中移除。被取消的任务不能继续执行,在线程池关闭的时候将从队列中移除</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kt>void</span> <span class=nf>cancelSchedule</span><span class=o>()</span> <span class=o>{</span>
    <span class=c1>// default false
</span><span class=c1></span>    <span class=n>service</span><span class=o>.</span><span class=na>setRemoveOnCancelPolicy</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=c1>// task to cancelled
</span><span class=c1></span>    <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>10</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
    <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>queue</span> <span class=o>=</span> <span class=n>service</span><span class=o>.</span><span class=na>getQueue</span><span class=o>();</span>
    <span class=n>Runnable</span> <span class=n>task</span> <span class=o>=</span> <span class=n>queue</span><span class=o>.</span><span class=na>peek</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=k>instanceof</span> <span class=n>RunnableScheduledFuture</span><span class=o>)</span> <span class=o>{</span>
        <span class=o>((</span><span class=n>FutureTask</span><span class=o>&lt;?&gt;)</span> <span class=n>task</span><span class=o>).</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
    <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
    <span class=c1>// should be 1
</span><span class=c1></span>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;queue size: &#34;</span> <span class=o>+</span> <span class=n>queue</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>

    <span class=n>service</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
    <span class=c1>// removed by onShutdown hook method
</span><span class=c1></span>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;queue size: &#34;</span> <span class=o>+</span> <span class=n>queue</span><span class=o>.</span><span class=na>size</span><span class=o>());</span>
<span class=o>}</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>TestScheduledPoolExecutor</span> <span class=n>ts</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TestScheduledPoolExecutor</span><span class=o>(</span><span class=n>0</span><span class=o>);</span>
    <span class=n>ts</span><span class=o>.</span><span class=na>cancelSchedule</span><span class=o>();</span>
<span class=o>}</span>
<span class=cm>/* output
</span><span class=cm>Thread[pool-1-thread-1,5,main] 1
</span><span class=cm>queue size: 1
</span><span class=cm>queue size: 0
</span><span class=cm>*/</span><span class=c1>//:~
</span></code></pre></td></tr></table>
</div>
</div><p>上例中，可以看到提交了2个任务，只有一个任务执行。首先提交的任务随即被取消了，第一次获取队列大小时，执行完一个任务，但是队列不为空，被取消的任务还在队列中，在线程池shutdown之后，任务随即被移除。如果使用<code>service.setRemoveOnCancelPolicy(true)</code>替换示例中的设置，那么两次获取的队列大小都是0。</p>
<p>这样的设计有一个好处，如果刻意取消一个任务，<strong>特定条件下可以避免重复的销毁和创建工作线程</strong>。在前面的讨论中，我们知道，核心线程空闲时是不会被销毁的，它会在任务队列上阻塞；但是非核心线程就不同了，如果队列为空，非核心线程会在<a href=#cp1>CP1</a>处结束运行，但是如果取消一个任务，并且任务没有从队列中移除的话，那么这个非核心线程就不会被销毁。</p>
<h1 id=6-关闭线程池>6 关闭线程池</h1>
<p>除了继承<code>ThreadPoolExecutor</code>的<a href=../%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/#3-3-%E5%A6%82%E4%BD%95%E5%90%88%E7%90%86%E5%9C%B0%E5%85%B3%E9%97%AD%E7%BA%BF%E7%A8%8B%E6%B1%A0>线程池关闭</a>的逻辑之外，<code>ScheduledThreadPoolExecutor</code>关闭线程池和其基类还有些许差异，主要是其通过实现<code>onShutdown</code>方法，实现了新的关闭策略。</p>
<h2 id=61-onshutdown方法>6.1 onShutDown方法</h2>
<p>调用<code>shutdown</code>和<code>shutdownNow</code>方法的基本逻辑和基类一致，不过<code>shutdown</code>过程中的<code>onShutdown</code>方法引入了新的关闭策略</p>
<p>关闭策略由2个布尔值域控制，分别是</p>
<ul>
<li>executeExistingDelayedTasksAfterShutdown = true; shutdown之后默认执行计划（单次）任务</li>
<li>continueExistingPeriodicTasksAfterShutdown;shutdown之后默认不执行周期任务</li>
</ul>
<p>这两个域可以在线程池初始化之后进行动态配置，默认情况下，调用<code>shutdown</code>方法之后，</p>
<ul>
<li>计划的（one-shot）任务将继续执行；</li>
<li>如果是周期任务，将从任务队列中移除；</li>
<li>已经取消的任务将会从队列中移除</li>
</ul>
<p>调用<code>shutdownNow</code>方法的逻辑则完全和基类一致，其会中断所有任务，返回丢弃的任务列表</p>
<p>以下是<code>onShutdown</code>方法的具体实现：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@Override</span> <span class=kt>void</span> <span class=nf>onShutdown</span><span class=o>()</span> <span class=o>{</span>
        <span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span> <span class=n>q</span> <span class=o>=</span> <span class=kd>super</span><span class=o>.</span><span class=na>getQueue</span><span class=o>();</span>
        <span class=kt>boolean</span> <span class=n>keepDelayed</span> <span class=o>=</span>
            <span class=n>getExecuteExistingDelayedTasksAfterShutdownPolicy</span><span class=o>();</span>
        <span class=kt>boolean</span> <span class=n>keepPeriodic</span> <span class=o>=</span>
            <span class=n>getContinueExistingPeriodicTasksAfterShutdownPolicy</span><span class=o>();</span>
        <span class=c1>// 如果shutdown之后既不执行计划任务也不执行周期任务
</span><span class=c1></span>        <span class=k>if</span> <span class=o>(!</span><span class=n>keepDelayed</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>keepPeriodic</span><span class=o>)</span> <span class=o>{</span>
            <span class=c1>// 那么取消所有任务的执行，并清空队列
</span><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=n>Object</span> <span class=n>e</span> <span class=o>:</span> <span class=n>q</span><span class=o>.</span><span class=na>toArray</span><span class=o>())</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=k>instanceof</span> <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;)</span>
                    <span class=o>((</span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;)</span> <span class=n>e</span><span class=o>).</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
            <span class=n>q</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
        <span class=o>}</span>
        <span class=k>else</span> <span class=o>{</span>
            <span class=c1>// Traverse snapshot to avoid iterator exceptions
</span><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=n>Object</span> <span class=n>e</span> <span class=o>:</span> <span class=n>q</span><span class=o>.</span><span class=na>toArray</span><span class=o>())</span> <span class=o>{</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>e</span> <span class=k>instanceof</span> <span class=n>RunnableScheduledFuture</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;</span> <span class=n>t</span> <span class=o>=</span>
                        <span class=o>(</span><span class=n>RunnableScheduledFuture</span><span class=o>&lt;?&gt;)</span><span class=n>e</span><span class=o>;</span>
                    <span class=c1>// 不管是在shutdown之后执行计划任务或者周期任务，都移除已经取消的任务
</span><span class=c1></span>                    <span class=c1>// 但是不移除计划执行的任务
</span><span class=c1></span>                    <span class=k>if</span> <span class=o>((</span><span class=n>t</span><span class=o>.</span><span class=na>isPeriodic</span><span class=o>()</span> <span class=o>?</span> <span class=o>!</span><span class=n>keepPeriodic</span> <span class=o>:</span> <span class=o>!</span><span class=n>keepDelayed</span><span class=o>)</span> <span class=o>||</span>
                        <span class=n>t</span><span class=o>.</span><span class=na>isCancelled</span><span class=o>())</span> <span class=o>{</span> <span class=c1>// also remove if already cancelled
</span><span class=c1></span>                        <span class=k>if</span> <span class=o>(</span><span class=n>q</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>t</span><span class=o>))</span>
                            <span class=n>t</span><span class=o>.</span><span class=na>cancel</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
                    <span class=o>}</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
        <span class=n>tryTerminate</span><span class=o>();</span>
    <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面的示例中，我们重新设置了线程池的关闭策略，以观察线程池在关闭时候的行为</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=nd>@SneakyThrows</span>
<span class=kt>void</span> <span class=nf>shutdownPolicy</span><span class=o>()</span> <span class=o>{</span>
   <span class=c1>// 如果任务在shutdown()之后仍在delay，那么将值设置为false可以取消任务的执行
</span><span class=c1></span>   <span class=c1>// 其默认值为true
</span><span class=c1></span>   <span class=n>service</span><span class=o>.</span><span class=na>setExecuteExistingDelayedTasksAfterShutdownPolicy</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
   <span class=n>service</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>);</span>

   <span class=c1>// 如果是周期执行的任务，将此值设置为true可以在调用shutdown()之后让其继续执行，否则结束执行
</span><span class=c1></span>   <span class=c1>// 其默认值为false
</span><span class=c1></span>   <span class=n>service</span><span class=o>.</span><span class=na>setContinueExistingPeriodicTasksAfterShutdownPolicy</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
   <span class=n>service</span><span class=o>.</span><span class=na>scheduleWithFixedDelay</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>s</span><span class=o>,</span> <span class=n>2</span><span class=o>,</span> <span class=n>1</span><span class=o>,</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>

   <span class=n>service</span><span class=o>.</span><span class=na>shutdown</span><span class=o>();</span>
   <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>10</span><span class=o>);</span>
   <span class=c1>// shutdownNow interrupt all tasks
</span><span class=c1></span>   <span class=n>service</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
   <span class=c1>// could be true or false
</span><span class=c1></span>   <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>service</span><span class=o>.</span><span class=na>isTerminated</span><span class=o>());</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>在<code>shutDown</code>之后，周期任务仍会一直执行，所以要使用<code>shutDownNow</code>来中止任务的执行</p>
<div class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>特殊地，当<code>corePoolSize = 0</code>时，池中仅可允许一个线程执行任务&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</div>
</article>
<script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script>'use strict';document.addEventListener('DOMContentLoaded',function(){var a=!1,b=document.querySelectorAll('pre.chroma'),c=document.querySelectorAll('.language-code'),d=document.querySelectorAll('div.language-\\$'),e=document.querySelectorAll('div.language-\\>'),f=function(c){var k=c,b=c.textContent,j,g,h,i,d,f,e;if(b.length>15){a||(j=new ClipboardJS('.copy-to-clipboard',{text:function(a){var c=prev(a).querySelectorAll('code');return c.length>1?b=prev(a).querySelector('code[class^="language-"]').textContent:b=prev(a).querySelector('code').textContent,b.replace(/^\$\s/gm,'')}}),j.on('success',function(a){a.clearSelection(),g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label','Copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),j.on('error',function(a){g=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label',a.action.toString()),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),a=!0),h=['language-mermaid','language-viz','language-wave','language-chart','language-msc','language-flowchart'],i=!1,d=k.getAttribute('class');for(f=0;f<h.length;f++)if(d&&d.startsWith(h[f])){i=!0;break}i||d&&(e=document.createElement('span'),e.setAttribute('class','copy-to-clipboard'),e.setAttribute('title','Copy to clipboard'),c.parentNode.parentNode.insertBefore(e,c.parentNode.nextElementSibling))}},g=function(b){var a=document.createElement('span');a.setAttribute('class','copy-to-clipboard'),a.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(a,b.parentNode.nextElementSibling)};b?b.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,c?c.forEach(function(a){a.querySelectorAll('code').forEach(function(a){f(a)})}):null,d?d.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null,e?e.forEach(function(a){a.querySelectorAll('code').forEach(function(a){g(a)})}):null})</script>
<script>'use strict';var langCodeElem,dollarCodeElem,gtCodeElem;function wrap(a,b){a.parentNode.insertBefore(b,a),b.appendChild(a)}(function(){var a=document.querySelector('.single__contents');a?a.querySelectorAll('pre > code').forEach(function(b){var a=b.getAttribute('data-lang'),c=document.createElement('div'),e=null,d=null;a&&a.includes(':')?(e=a.split(':')[0],d=a.split(':')[1],c.className='language-'+e,c.setAttribute('data-lang',d),b.className='language-'+e,b.setAttribute('data-lang',d),b.setAttribute('id',d)):a||(c.setAttribute('data-lang','Code'),c.className='language-code'),(!a||d)&&wrap(b.parentNode,c)}):null})(),langCodeElem=document.querySelectorAll('.language-code'),langCodeElem?langCodeElem.forEach(function(b){var a=document.createElement('span');a.className='copy-to-clipboard',a.setAttribute('title','Copy to clipboard'),b.append(a)}):null,dollarCodeElem=document.querySelectorAll('div.language-\\$'),gtCodeElem=document.querySelectorAll('div.language-\\>'),dollarCodeElem?dollarCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='$<br/>'}):null}):null,gtCodeElem?gtCodeElem.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='><br/>'}):null}):null</script>
<div class=whoami__gutter></div>
<hr class="hr-slash whoami-hr">
<section class=whoami>
<div class=whoami__image-wrapper>
<img data-src=/images/whoami/avatar.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=wangy325 class="lazyload whoami__image">
</div>
<div class=whoami__contents>
<div class=whoami__written-by>
作者
</div>
<div class=whoami__title>
wangy325
</div>
<div class=whoami__desc>
Web Developer
</div>
<div class=whoami__social>
<a href=mailto:wangy325@qq.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg>
</a>
<a href=https://github.com/wangy325/endlessriver title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg>
</a>
</div>
</div>
</section>
<hr class="hr-slash whoami-hr">
<section class=related>
<h1 class=related__title>
<hr class=hr-dots>
<div>
相关内容
</div>
<hr class=hr-dots>
</h1>
<ul class=related-ul>
<li>
<a href=/zh/posts/java/concurrency/7%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=related__link>Java并发系列之7——执行器与线程池</a>
</li>
</ul>
</section>
<div class=grow></div>
<nav class=pagination-single>
<a href=https://wangy325.github.io/zh/posts/java/concurrency/7%E6%89%A7%E8%A1%8C%E5%99%A8%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=pagination-single__left>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg>
</div>
<div class=pagination-single__left-title>Java并发系列之7——执行器与线程池</div>
</a>
<div class=grow></div>
<a href=https://wangy325.github.io/zh/posts/java/concurrency/9%E5%85%B6%E4%BB%96%E9%87%8D%E8%A6%81%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BB%84%E4%BB%B6/ class=pagination-single__right>
<div class=pagination-single__right-title>Java并发系列之9——一些重要的并发组件</div>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg>
</div>
</a>
</nav>
<div class="modal micromodal-slide" id=modal aria-hidden=true>
<div class=modal__overlay tabindex=-1 data-micromodal-close>
<div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title>
<div class=modal__content id=modal-content>
<div id=mySwipe class=swipe>
<div class=swipe-wrap>
</div>
</div>
</div>
<span class=modal__items>
<span class=modal__header>
<div class=modal__paging title="Page Info" aria-label="Current Page">
</div>
<div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg>
</div>
</span>
<div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg>
</div>
<div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg>
</div>
<div class=modal__caption>
<div class=modal__caption--text>
</div>
</div>
</span>
</div>
</div>
</div>
<script defer src=/js/swipe.min.989e074dfb92ce7f57a92c1df7027f88b53c50a54fd9ad450a673a64aa91bfa4.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener('DOMContentLoaded',function(){var d=document.documentElement,g,f,s,r,m,o,l,b,c,i,n,e,h,j,a,p,q;function t(){d.requestFullscreen?d.requestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&d.msRequestFullscreen()}function k(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}g=document.getElementById('modal'),f=document.querySelector('.gallery__container'),s=document.querySelector('.swipe-wrap'),r=document.getElementById('mySwipe'),m=document.querySelector('.modal__arrow--left'),o=document.querySelector('.modal__arrow--right'),l=document.querySelector('.modal__toolbar--close'),b=document.querySelector('.modal__toolbar--full'),c=document.querySelector('.modal__toolbar--normal'),i=document.querySelector('.modal__caption'),n=document.querySelector('.modal__paging'),e=document.querySelector('.modal__items'),h=null,j=null,a=null,p=function(b){b.key==='ArrowRight'?g&&g.classList.contains('is-open')&&a.next():b.key==='ArrowLeft'&&g&&g.classList.contains('is-open')&&a.prev()},f?h=f.querySelectorAll('img').length:(f=document.querySelector('.single__contents'),h=f.querySelectorAll('img').length),MicroModal.init({onClose:function(){a&&(a.kill(),a=null,k()),window.removeEventListener('keydown',p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),q=function(a){return new Promise(function(c,d){var b=new Image;b.onload=function(){c(b)},b.onerror=d,b.src=a})},f.querySelectorAll('img').forEach(function(g,k){var f,d;g.style.cursor='pointer',f=g.cloneNode(!0),f.style.maxHeight='100%',f.style.maxWidth='100%',f.onclick=function(a){a.stopPropagation()},d=document.createElement('div'),d.style.width='100%',d.style.height='100vh',d.setAttribute('data-micromodal-close',''),d.onclick=function(){a&&(a.kill(),a=null)},d.onmouseenter=function(){clearTimeout(j),fadeIn(e,200)},d.onmouseleave=function(){j=setTimeout(function(){fadeOut(e,200)},2500)},d.ontouchstart=function(){fadeIn(e,200)},d.append(f),s.append(d),g.addEventListener('click',async function(d){var m,l,g;MicroModal.show('modal'),a&&(a.kill(),a=null),m=d.target.getAttribute('data-src')||d.target.getAttribute('src'),l=await q(m),f.style.width=l.width+'px',f.style.height=l.height+'px',a=new Swipe(r,{startSlide:k,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(d,f){var a=f.querySelector('img'),g=a.getAttribute('data-src')||a.getAttribute('src'),c=await q(g),b;a.style.width=c.width+'px',a.style.height=c.height+'px',i&&a&&(b=null,a.getAttribute('data-caption')?b=a.getAttribute('data-caption'):a.getAttribute('title')?b=a.getAttribute('title'):a.getAttribute('alt')?b=a.getAttribute('alt'):b=a.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=b,n.innerText=d+1+' / '+h,clearTimeout(j),fadeIn(e,200))}}),fadeIn(e),i&&(g=null,d.target.getAttribute('data-caption')?g=d.target.getAttribute('data-caption'):d.target.getAttribute('title')?g=d.target.getAttribute('title'):d.target.getAttribute('alt')?g=d.target.getAttribute('alt'):g=d.target.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=g,n.innerText=k+1+' / '+h),c&&b&&(c.style.zIndex=-1,c.style.opacity=0,b.style.zIndex=25,b.style.opacity=1)}),window.addEventListener('keydown',p)}),m?m.addEventListener('click',function(b){a&&a.prev()}):null,o?o.addEventListener('click',function(b){a&&a.next()}):null,l?l.addEventListener('click',function(){a&&(a.kill(),a=null),k(),MicroModal.close('modal')}):null,b?b.addEventListener('click',function(a){t(),c&&(c.style.zIndex=25,c.style.opacity=1,b.style.zIndex=-1,b.style.opacity=0)}):null,c?c.addEventListener('click',function(a){k(),b&&(b.style.zIndex=25,b.style.opacity=1,c.style.zIndex=-1,c.style.opacity=0)}):null})</script>
<div class=hide>
<div class=search>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</span>
<input id=search aria-label="Site Search" class=input type=text placeholder=搜索 autocomplete=off>
<div id=search-results class=dropdown>
<div id=search-menu class=dropdown-menu role=menu>
</div>
</div>
</div>
</div>
</div>
</main>
<script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"outer"'),singleMainElem=document.querySelector('.single__main'),singleSideElem=document.querySelector('.single__side');enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main'),singleSideElem.classList.remove('main-side'),singleSideElem.classList.add('hide')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide'))},unmatch:function(){var b,a;(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove('main'),singleMainElem.classList.add('main-main'),singleSideElem.classList.remove('hide'),singleSideElem.classList.add('main-side')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide')),b=document.querySelector('.navbar__burger'),a=document.getElementsByClassName('navbarm__collapse')[0],a&&(a.setAttribute('data-open',!1),a.style.maxHeight=0,b.classList.remove('is-active')),document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active'),document.getElementsByClassName('mobile-search')[0].classList.add('hide')},setup:function(){},deferSetup:!0,destroy:function(){}})</script>
<script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script defer src=/js/helper/throttle.min.js></script>
<script>'use strict';window.onload=function(){var f=document.querySelector('.navbar'),D=document.querySelector('.single__contents'),E=JSON.parse("true"),J=JSON.parse("true"),s,H,F,L,k,j,A,g,u,x,d,e,l,i,I,C,K,v,N,y,r,z,b,w,t,M,h,c,G,a,m,n,o,p,B,q;E&&J&&(s=document.querySelector('#busuanzi_value_page_pv'),s.textContent=s.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),H=JSON.parse("true"),F=JSON.parse("null"),L=JSON.parse("false"),k=document.querySelector('.toc__flexbox'),j=document.querySelector('.toc__flexbox--outer'),A=JSON.parse("false"),(H||F)&&document.querySelector('.toc')&&(g=document.querySelector('.toc').querySelector('#TableOfContents'),g.onmouseenter=function(){f.classList.contains('scrolling')&&f.classList.remove('scrolling')},g.onmouseleave=function(){f.classList.contains('scrolling')||f.classList.add('scrolling')},!1===A||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),g&&(g.querySelectorAll('a').length>0?g.querySelectorAll('a').forEach(function(a){a.addEventListener('click',function(){var c=a.getAttribute('id'),b;f.classList.contains('scrolling')||(f.classList.remove('navbar--show'),f.classList.remove('navbar--hide'),f.classList.add('navbar--hide')),document.querySelector('.toc').querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),a.classList.add('active'),b=g.querySelector('[href="#'+c+'"]'),b&&b.nextElementSibling&&(b.nextElementSibling.style.display='block'),b&&(getParents(b,'ul')?getParents(b,'ul').forEach(function(a){a.style.display='block'}):null)})}):(k&&(k.setAttribute('data-position',''),k.classList.contains('hide')||k.classList.add('hide')),j&&(j.setAttribute('data-position',''),j.classList.contains('hide')||j.classList.add('hide')))),u=document.getElementById("toggle-toc"),x=document.getElementById('visible-toc'),d=document.querySelector('.toc'),e=document.querySelector('main'),l=document.querySelector('side'),i=document.querySelector('.toc__flexbox'),u?u.addEventListener('change',function(a){a.target.checked?(d&&fadeIn(d,200),i&&i.setAttribute('data-position','fixed'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main-main')),l&&l.classList.remove('main-side')):(d&&fadeOut(d,200),i&&i.setAttribute('data-position','absolute'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main')),l&&l.classList.remove('main-side'))}):null,x?x.addEventListener('change',function(a){a.target.checked?d&&fadeIn(d,200):d&&fadeOut(d,200)}):null),I=120,C=70,K=function(){d&&(d.style.maxHeight=window.innerHeight-I-C+'px')},v=throttle(K,300),v(),window.addEventListener('resize',v),y=new ClipboardJS('.anchor'),r=D.querySelectorAll("h1, h2, h3, h4"),z=JSON.parse('"ltr"'),r?r.forEach(function(c){var d=parseInt(c.tagName.substr(1),10)*2,e=encodeURI(document.location.origin+document.location.pathname),f=e+"#"+c.getAttribute('id'),b=document.createElement('span'),a;b.classList.add('anchor'),b.classList.add('hide'),b.setAttribute('data-clipboard-text',decodeURI(f)),b.style.position='relative',a=document.createElement('span'),a.style.position='absolute',a.style.top='50%',a.style.left='0.75rem',a.style.transform='translateY(-50%)',a.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-d}px" height="${32-d}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,z==="rtl"?a.style.left='-2rem':a.style.right='-2rem',b.append(a),c.append(b),c.addEventListener('mouseenter',function(){this.querySelector('.anchor').classList.remove('hide')}),c.addEventListener('mouseleave',function(){this.querySelector('.anchor').classList.add('hide')})}):null,document.querySelectorAll('.anchor').forEach(function(a){a.addEventListener('mouseleave',function(){a.setAttribute('aria-label',null),a.classList.remove('tooltipped'),a.classList.remove('tooltipped-s'),a.classList.remove('tooltipped-w')})}),y.on('success',function(a){a.clearSelection(),a.trigger.setAttribute('aria-label','Link copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-s')}),b=JSON.parse("null"),b&&b.includes('mermaid')&&(w=localStorage.getItem('theme')||JSON.parse('"light"'),w==="dark"||w==="hacker"?mermaid.initialize({theme:'dark'}):mermaid.initialize({theme:'default'}),t=[],[].push.apply(t,document.getElementsByClassName('language-mermaid')),t.forEach(function(b){var a=b.parentNode,c;a!==document.body&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)),c=document.createElement('div'),c.classList.add('mermaid'),c.style.padding='34px 4px 6px',c.innerHTML=b.innerHTML,b.replaceWith(c)})),b&&b.includes('katex')&&(M=document.getElementsByClassName('math'),h={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector('.single__contents'),h)),b&&b.includes('flowchartjs')&&(h=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),c=null,G="language-flowchart",a=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+G+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='flowchart'+a,b.parentNode.insertBefore(d,b),e=flowchart.parse(c),e.drawSVG("flowchart"+a,h),a+=1})),document.querySelectorAll("mjx-container").forEach(function(a){a.parentElement.classList+='has-jax'}),b&&b.includes('msc')&&(h=JSON.parse('{"theme":"hand"}'),c=null,a=0,m="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='msc'+a,b.parentNode.insertBefore(d,b),e=Diagram.parse(c),e.drawSVG("msc"+a,h),a+=1})),b&&b.includes('chart')&&(n="#666",o="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=n,Chart.defaults.global.elements.rectangle.backgroundColor=o,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=n,Chart.defaults.global.elements.line.backgroundColor=o,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=n,Chart.defaults.global.elements.point.backgroundColor=o,m="language-chart",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+m+"]"),function(b){var d,e,f,g;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('canvas'),e=null,d.height=200,d.style.height=200,d.id='myChart'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),f=document.getElementById('myChart'+a).getContext('2d'),g=new Chart(f,e),a+=1})),b&&b.includes('wavedrom')&&(B="language-wave",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+B+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),e=null,d.id='WaveDrom_Display_'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),WaveDrom.RenderWaveForm(a,e,"WaveDrom_Display_"),a+=1})),b&&b.includes('viz')&&(q="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+q+"]"),function(a){var b,c;a.style.display='none',a.parentNode.style.backgroundColor="transparent",a.getAttribute("class").split(" ").forEach(function(a){a.startsWith(q)&&(b=a.substr(q.length))}),c=new Viz,c.renderSVGElement(a.innerText,{engine:b}).then(function(b){b.style.width="100%",a.parentNode.insertBefore(b,a)})}))}</script>
<footer class=footer>
<div class=dropdown>
<button class=dropdown-trigger aria-label="Select Language Button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03c1.74-1.94 2.98-4.17 3.71-6.53h1.94c.54.0.99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54.0-.99.45-.99.99.0.55.45.99.99.99h10.18C11.5 7.92 10.44 9.75 9 11.35c-.81-.89-1.49-1.86-2.06-2.88-.16-.29-.45-.47-.78-.47-.69.0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87c-.4.39-.4 1.03.0 1.42.39.39 1.02.39 1.42.0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35zM17.5 10c-.6.0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39.0.74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65.0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94zm-1.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
</button>
<div class=dropdown-content>
<a href=https://wangy325.github.io/zh/posts/java/concurrency/8%E8%AE%A1%E5%88%92%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/ data-lang=zh class="dropdown-item is-active">简体中文</a>
</div>
</div>
<div class=footer__social>
<div class=social>
<a href=mailto:wangy325@qq.com title=email aria-label=email><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-.4 4.25-7.07 4.42c-.32.2-.74.2-1.06.0L4.4 8.25c-.25-.16-.4-.43-.4-.72.0-.67.73-1.07 1.3-.72L12 11l6.7-4.19c.57-.35 1.3.05 1.3.72.0.29-.15.56-.4.72z"/></svg>
</a>
<a href=https://github.com/wangy325/endlessriver title=github aria-label=github><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 24 24"><g id="surface3680"><path fill="currentcolor" d="M10.898438 2.101562c-4.597657.5-8.296876 4.199219-8.796876 8.699219-.5 4.699219 2.199219 8.898438 6.296876 10.5C8.699219 21.398438 9 21.199219 9 20.800781V19.199219S8.601562 19.300781 8.101562 19.300781c-1.402343.0-2-1.199219-2.101562-1.902343C5.898438 17 5.699219 16.699219 5.398438 16.398438 5.101562 16.300781 5 16.300781 5 16.199219 5 16 5.300781 16 5.398438 16 6 16 6.5 16.699219 6.699219 17c.5.800781000000001 1.101562 1 1.402343 1C8.5 18 8.800781 17.898438 9 17.800781 9.101562 17.101562 9.398438 16.398438 10 16c-2.300781-.5-4-1.800781-4-4 0-1.101562.5-2.199219 1.199219-3C7.101562 8.800781 7 8.300781 7 7.601562c0-.402343.0-1 .300781-1.601562.0.0 1.398438.0 2.800781 1.300781C10.601562 7.101562 11.300781 7 12 7s1.398438.101562 2 .300781C15.300781 6 16.800781 6 16.800781 6 17 6.601562 17 7.199219 17 7.601562 17 8.398438 16.898438 8.800781 16.800781 9 17.5 9.800781 18 10.800781 18 12c0 2.199219-1.699219 3.5-4 4 .601562.5 1 1.398438 1 2.300781v2.597657C15 21.199219 15.300781 21.5 15.699219 21.398438 19.398438 19.898438 22 16.300781 22 12.101562c0-6-5.101562-10.703124-11.101562-10zm0 0"/></g></svg>
</a>
<a href=https://wangy325.github.io/zh/posts/index.xml type=application/rss+xml title=RSS aria-label="RSS Feed Link"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentcolor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentcolor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4.0.71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85.0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84.0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg>
</a>
</div>
</div>
<div id=gtt>
<div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg>
</div>
</div>
<hr>
<div class="basicflex flexwrap">
</div>
<div class=footer__poweredby>
<div class=busuanzi>
<div class=busuanzi__item>
<span class=busuanzi__item--label>
总访客
</span>
<span id=busuanzi_value_site_uv class=busuanzi__item--number>...</span>
</div>
<div class=busuanzi__item>
<span class=busuanzi__item--label>
总浏览
</span>
<span id=busuanzi_value_site_pv class=busuanzi__item--number>...</span>
</div>
</div>
<p class=caption>
©2019-2022, All Rights Reserved<a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/> CC BY-SA</a>
</p>
<p class=caption>Powered by <a href=https://gohugo.io/ target=_blank rel=noreferrer>Hugo</a> and the <a href=https://github.com/zzossig/hugo-theme-zzo target=_blank rel=noreferrer>Zzo theme</a></p>
</div>
</footer>
</div>
<div class="wrapper__right hide" data-pad=true dir=ltr>
<script>document.querySelector('.wrapper__right').classList.remove('hide')</script>
<div class=toc__flexbox--outer data-position=fixed data-dir=ltr data-ani=true>
<h6 class="toc__title toc__title--outer" data-ani=true>目录</h6>
</div>
<div class="toc toc__outer" data-dir=ltr data-folding=false data-ani=true>
<nav id=TableOfContents>
<ul>
<li><a href=#1-scheduledexecutorservice>1 ScheduledExecutorService</a></li>
<li><a href=#2-scheduledthreadpoolexecutor>2 ScheduledThreadPoolExecutor</a>
<ul>
<li><a href=#21-构造器>2.1 构造器</a></li>
<li><a href=#22-域>2.2 域</a></li>
<li><a href=#23-方法>2.3 方法</a></li>
<li><a href=#24-由executors构造的scheduledthreadpoolexecutor>2.4 由Executors构造的ScheduledThreadPoolExecutor</a></li>
</ul>
</li>
<li><a href=#3-内部结构>3 内部结构</a>
<ul>
<li><a href=#31-scheduledfuturetask>3.1 ScheduledFutureTask</a>
<ul>
<li><a href=#311-域>3.1.1 域</a></li>
<li><a href=#312-构造器>3.1.2 构造器</a></li>
<li><a href=#313-方法>3.1.3 方法</a>
<ul>
<li><a href=#1-compareto><strong>1 compareTo</strong></a></li>
<li><a href=#2-setnextruntime><strong>2 setNextRunTime</strong></a></li>
<li><a href=#3-run><strong>3 run</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#32-delayedworkqueue>3.2 DelayedWorkQueue</a></li>
</ul>
</li>
<li><a href=#4-任务执行流程>4 任务执行流程</a>
<ul>
<li><a href=#41-提交任务>4.1 提交任务</a></li>
<li><a href=#42-任务入队>4.2 任务入队</a></li>
<li><a href=#43-执行任务>4.3 执行任务</a></li>
<li><a href=#44-任务出队>4.4 任务出队</a></li>
</ul>
</li>
<li><a href=#5-取消任务>5 取消任务</a></li>
<li><a href=#6-关闭线程池>6 关闭线程池</a>
<ul>
<li><a href=#61-onshutdown方法>6.1 onShutDown方法</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
</body>
</html>